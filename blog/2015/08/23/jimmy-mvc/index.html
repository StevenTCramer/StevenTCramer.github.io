
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Building MVC Jimmy Style - Cramer on Code</title>
  <meta name="author" content="Steven T. Cramer">

  
  <meta name="description" content="Creating a Jimmy Bogard style MVC template application">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://steventcramer.github.io//blog/2015/08/23/jimmy-mvc/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Cramer on Code" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', '66500618']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Cramer on Code</a></h1>
  
    <h2>Software Development blog</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="steventcramer.github.io/">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Building MVC Jimmy Style</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-08-23T13:13:37-04:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>1:13 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>This blog is a step by step tutorial that transforms a default MVC 5 application into <a href="https://lostechies.com/jimmybogard/">Jimmy Bogard&#39;s</a> Feature oriented configuration as described in his <a href="https://lostechies.com/jimmybogard/2015/07/02/ndc-talk-on-solid-in-slices-not-layers-video-online/">presentation</a>. His sample project located <a href="https://github.com/jbogard/ContosoUniversity" title="here">here</a> was used to guide the way.  The VSIX package and source code of this presentation are available <a href="/assets/pictures/jimmy-mvc/JimmyMvcVsixProject.vsix">here</a>.</p>

<!-- more -->

<h1>Background</h1>

<h2>Layers to Features</h2>

<p><strong>From:</strong>
<img src="/assets/pictures/jimmy-mvc/Layers.png" alt="NewProject"></p>

<p><strong>To:</strong> 
<img src="/assets/pictures/jimmy-mvc/Features.png" alt="NewProject"></p>

<h2>What is a feature</h2>

<p>A feature is a small vertical slice of a web site. The <strong>M</strong>odel, <strong>V</strong>iew and <strong>C</strong>ontroller of a <strong>single url</strong>.  It can contain the following:
- Query
- QueryValidater
- QueryHandler
- Result
- Command
- CommandValidater
- CommandHandler
- UiController
- MappingProfile
- View  </p>

<p>A Feature handles the <code>get</code> and or <code>post</code> of an http requests for a single url.<br>
Examples: <code>http://localhost/User/Index</code>, <code>http://localhost/User/Create</code> 
It can be synchronous or asynchronous, and can have a redirect to url/Feature upon command success.  Features use the <strong>CQRS light</strong> design pattern.</p>

<h2>CQRS Light</h2>

<p>The CQRS (Command Query Responsibility Segregation) pattern means many different thing to different people.  The full blown CQRS with dual domain models and event sourcing etc. gets a bit overwhelming rather quickly.  &quot;<a href="https://lostechies.com/jimmybogard/2015/05/05/cqrs-with-mediatr-and-automapper/">CQRS Light</a>&quot; is just the splitting of Features into Queries and Commands.  A single domain model is the starting point and will not be split unless circumstances drive the need, which is unlikely.  There is no event sourcing and most messaging is done in process using MediatR.</p>

<p>The Http protocol correlates rather well with CQRS Light.</p>

<p>Get = Read = Query
Post = Write = Command</p>

<p>The MediatR Nuget package will be used to implement CQRS light.</p>

<p><img src="/assets/pictures/jimmy-mvc/MediatR.png" alt="MediatR"></p>

<p>This should all become clear as we implement. Let&#39;s get started.</p>

<h1>Tutorial</h1>

<h2>Create Default MVC 5 Application</h2>

<p>Create New Project named JimmyMvc</p>

<p><img src="/assets/pictures/jimmy-mvc/NewProject.png" alt="NewProject"></p>

<p>Choose <code>MVC</code> and Press <code>Change Authentication</code> and select &quot;No Authentication&quot; </p>

<p><img src="/assets/pictures/jimmy-mvc/SelectTemplate.png" alt="NewProject"></p>

<p>Deselect <code>Host in the cloud</code></p>

<p><img src="/assets/pictures/jimmy-mvc/NoAuthentication.png" alt="NewProject"></p>

<p>Select Ok to create the project.</p>

<p>Run the app to confirm it works as is.</p>

<p><img src="/assets/pictures/jimmy-mvc/ScreenShot.png" alt="NewProject"></p>

<p>Select <em>Tools-&gt;NuGet Package Manager-&gt;Package Manager Console</em> and enter: </p>

<p><code>Update-Package</code></p>

<p>Alternatively Select <em>Tools-&gt;NuGet Package Manager-&gt;Manage NuGet Packages for Solution</em></p>

<p>Upgrade all to the latest stable version.</p>

<p>Run the app to confirm it still works.</p>

<h2>Configure JustCode/ReSharper/CodeRush</h2>

<p>These tools are not required but they sure are handy.  Take some time to configure them and they will help make your code cleaner and more consistent.  This will not be covered here.</p>

<h2>Rename Views to Features</h2>

<p>Rename the <code>Views</code> folder to <code>Features</code></p>

<p><img src="/assets/pictures/jimmy-mvc/FeatureFolder.png" alt="NewProject"></p>

<p>So now if you run the app you will get an error:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>The view 'Index' or its master was not found or no view engine supports the searched locations. The following locations were searched:
</span><span class='line'>~/Views/Home/Index.aspx
</span><span class='line'>~/Views/Home/Index.ascx
</span><span class='line'>~/Views/Shared/Index.aspx
</span><span class='line'>~/Views/Shared/Index.ascx
</span><span class='line'>~/Views/Home/Index.cshtml
</span><span class='line'>~/Views/Home/Index.vbhtml
</span><span class='line'>~/Views/Shared/Index.cshtml
</span><span class='line'>~/Views/Shared/Index.vbhtml
</span></code></pre></td></tr></table></div></figure>
 

<p>To fix this we change the view engine to one that looks in the proper location:</p>

<p>Create a new root folder named <code>Infrastructure</code>
<img src="/assets/pictures/jimmy-mvc/InfrastructureFolder.png" alt="NewProject"></p>

<p>Inside the Infrastructure folder Create new class named: <code>FeatureRazorViewEngine</code>  </p>

<p>Implement as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">FeatureRazorViewEngine</span> <span class="p">:</span> <span class="n">RazorViewEngine</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="nf">FeatureRazorViewEngine</span><span class="p">()</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">ViewLocationFormats</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="s">&quot;~/Features/{1}/{0}.cshtml&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="s">&quot;~/Features/{1}/{0}.vbhtml&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="s">&quot;~/Features/Shared/{0}.cshtml&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="s">&quot;~/Features/Shared/{0}.vbhtml&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">MasterLocationFormats</span> <span class="p">=</span> <span class="n">ViewLocationFormats</span><span class="p">;</span>
</span><span class='line'>          <span class="n">PartialViewLocationFormats</span> <span class="p">=</span> <span class="n">ViewLocationFormats</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
  

<p>To use the new ViewEngine, update the <code>Global.asax.cs</code> as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Infrastructure</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Optimization</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Routing</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">MvcApplication</span> <span class="p">:</span> <span class="n">System</span><span class="p">.</span><span class="n">Web</span><span class="p">.</span><span class="n">HttpApplication</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">protected</span> <span class="k">void</span> <span class="nf">Application_Start</span><span class="p">()</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">AreaRegistration</span><span class="p">.</span><span class="n">RegisterAllAreas</span><span class="p">();</span>
</span><span class='line'>          <span class="n">FilterConfig</span><span class="p">.</span><span class="n">RegisterGlobalFilters</span><span class="p">(</span><span class="n">GlobalFilters</span><span class="p">.</span><span class="n">Filters</span><span class="p">);</span>
</span><span class='line'>          <span class="n">RouteConfig</span><span class="p">.</span><span class="n">RegisterRoutes</span><span class="p">(</span><span class="n">RouteTable</span><span class="p">.</span><span class="n">Routes</span><span class="p">);</span>
</span><span class='line'>          <span class="n">BundleConfig</span><span class="p">.</span><span class="n">RegisterBundles</span><span class="p">(</span><span class="n">BundleTable</span><span class="p">.</span><span class="n">Bundles</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Replace Default ViewEngine with Feature version</span>
</span><span class='line'>          <span class="n">ViewEngines</span><span class="p">.</span><span class="n">Engines</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
</span><span class='line'>          <span class="n">ViewEngines</span><span class="p">.</span><span class="n">Engines</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">FeatureRazorViewEngine</span><span class="p">());</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
 

<p>Running the application now should give you :</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">The layout page &quot;~/Views/Shared/_Layout.cshtml&quot; could not be found at the following path: &quot;~/Views/Shared/_Layout.cshtml&quot;.
</code></pre></div>
<p>To fix this, Update the <code>_ViewStart.cshtml</code> to point to the Feature based site Layout location.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="err">@</span><span class="p">{</span>
</span><span class='line'>    <span class="n">Layout</span> <span class="p">=</span> <span class="s">&quot;~/Features/Shared/_Layout.cshtml&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
 

<p>You application will now function using the &quot;Feature&quot; folder instead of the &quot;View&quot; folder.</p>

<h2>Removing the Controllers Folder</h2>

<p>Move <code>HomeController.cs</code> to the <code>Features\Home</code> directory and delete the Controllers folder.</p>

<p>Using the feature concept we no longer have to indicate the purpose of the controller by calling it &lt;<em>Home</em>&gt;Controller.  Given it is in the <em>Home</em> namespace the prefix becomes redundant.</p>

<p>Rename <code>HomeController.cs</code> to <code>UiController.cs</code> and the class name to <code>UiController</code></p>

<p>Update the namespace inside the file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Features.Home</span>
</span></code></pre></td></tr></table></div></figure>
 

<p>Running the application will now give an error:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">The resource cannot be found.
</code></pre></div>
<p>The url format is set in the <code>RouteConfig</code> as follows: (<em>Notice this is the default and is not changed.</em>)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">routes</span><span class="p">.</span><span class="n">MapRoute</span><span class="p">(</span>
</span><span class='line'>              <span class="n">name</span><span class="p">:</span> <span class="s">&quot;Default&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="n">url</span><span class="p">:</span> <span class="s">&quot;{controller}/{action}/{id}&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="n">defaults</span><span class="p">:</span> <span class="k">new</span> <span class="p">{</span> <span class="n">controller</span> <span class="p">=</span> <span class="s">&quot;Home&quot;</span><span class="p">,</span> <span class="n">action</span> <span class="p">=</span> <span class="s">&quot;Index&quot;</span><span class="p">,</span> <span class="n">id</span> <span class="p">=</span> <span class="n">UrlParameter</span><span class="p">.</span><span class="n">Optional</span> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>MVC controllers are created using the <code>DefaultControllerFactory.CreateController</code> and it uses a naming convention of <code>&lt;controllerName&gt;Controller</code> to get the controller type.  This will no longer work with our new feature based naming convention.</p>

<p>To fix this create your own controller factory class in the <code>Infrastructure</code> Folder as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Routing</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">ControllerFactory</span> <span class="p">:</span> <span class="n">DefaultControllerFactory</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">protected</span> <span class="k">override</span> <span class="n">Type</span> <span class="nf">GetControllerType</span><span class="p">(</span><span class="n">RequestContext</span> <span class="n">aRequestContext</span><span class="p">,</span> <span class="kt">string</span> <span class="n">aControllerName</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">action</span> <span class="p">=</span> <span class="n">aRequestContext</span><span class="p">.</span><span class="n">RouteData</span><span class="p">.</span><span class="n">GetRequiredString</span><span class="p">(</span><span class="n">valueName</span><span class="p">:</span> <span class="s">&quot;action&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">typeName</span> <span class="p">=</span> <span class="s">&quot;JimmyMvc.Features.&quot;</span> <span class="p">+</span> <span class="n">aControllerName</span> <span class="p">+</span> <span class="s">&quot;.UiController&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">System</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">Assembly</span> <span class="n">assembly</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">ControllerFactory</span><span class="p">).</span><span class="n">Assembly</span><span class="p">;</span>
</span><span class='line'>          <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="n">assembly</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="n">typeName</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>To use this controller factory set it directly in the <code>Global.asax.cs</code> file using:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">ControllerBuilder</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">SetControllerFactory</span><span class="p">(</span><span class="k">new</span> <span class="n">JimmyMvc</span><span class="p">.</span><span class="n">Infrastructure</span><span class="p">.</span><span class="n">ControllerFactory</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>

<p>Later after we add an IoC container this will need to be removed.</p>

<p>At this point the <code>Global.asax.cs</code> file should be as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Infrastructure</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Optimization</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Routing</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">MvcApplication</span> <span class="p">:</span> <span class="n">System</span><span class="p">.</span><span class="n">Web</span><span class="p">.</span><span class="n">HttpApplication</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">protected</span> <span class="k">void</span> <span class="nf">Application_Start</span><span class="p">()</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">AreaRegistration</span><span class="p">.</span><span class="n">RegisterAllAreas</span><span class="p">();</span>
</span><span class='line'>          <span class="n">FilterConfig</span><span class="p">.</span><span class="n">RegisterGlobalFilters</span><span class="p">(</span><span class="n">GlobalFilters</span><span class="p">.</span><span class="n">Filters</span><span class="p">);</span>
</span><span class='line'>          <span class="n">RouteConfig</span><span class="p">.</span><span class="n">RegisterRoutes</span><span class="p">(</span><span class="n">RouteTable</span><span class="p">.</span><span class="n">Routes</span><span class="p">);</span>
</span><span class='line'>          <span class="n">BundleConfig</span><span class="p">.</span><span class="n">RegisterBundles</span><span class="p">(</span><span class="n">BundleTable</span><span class="p">.</span><span class="n">Bundles</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Replace Default ViewEngine with Feature version</span>
</span><span class='line'>          <span class="n">ViewEngines</span><span class="p">.</span><span class="n">Engines</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
</span><span class='line'>          <span class="n">ViewEngines</span><span class="p">.</span><span class="n">Engines</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">FeatureRazorViewEngine</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Replace Default Controller factor with Feature version</span>
</span><span class='line'>          <span class="n">ControllerBuilder</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">SetControllerFactory</span><span class="p">(</span><span class="k">new</span> <span class="n">JimmyMvc</span><span class="p">.</span><span class="n">Infrastructure</span><span class="p">.</span><span class="n">ControllerFactory</span><span class="p">());</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>The Application should now run.  But what is the purpose of this application?</p>

<h2>The Business Case</h2>

<p>A Company wants to automate their purchase order (PO) approval process. To reduce clutter and wasted time, they want to establish a hierarchy for approval.  People in the first group must approve before requesting action from the second.  All of the people in the list must approve the PO in order for the funds to be allocated and the PO be issued as approved.</p>

<p>Typically the team that is closest to the project, needs to approve first.  If all of them approve then the next group will be notified and requested to approve or reject.  This second group is often a set of managers involved in a project.  Finally the next group, potentially senior executives are involved. Lastly one person must have the financial signing authority to release the funds.</p>

<p>This blog only covers the implementation of &quot;Approval List <strong>Templates</strong>&quot; which can be reused when the user actually wants to request approval of a purchase order. The process of requesting approval of the purchase order is another business component and is not covered in this post.</p>

<p>Sample &quot;Approval List Template&quot; names are ... &quot;Minimal Approval&quot;, &quot;Medium Approval&quot;, &quot;The Big Dogs&quot;</p>

<h3>Class Diagram</h3>

<p><img src="/assets/pictures/jimmy-mvc/Main.png" alt="Model"></p>

<p>Granted this model is pretty simple in that the behavior is just CRUD. The use of the ApprovalListTemplate will have more domain behavior and possibly could be the topic of a future blog.</p>

<h3>Use Case</h3>

<p>Let&#39;s get started with our first use case. </p>

<p>As an administrator we need to be able to maintain a set of users for the application.  </p>

<p>TODO Use case Diagram here</p>

<p>Being able to persist users will require a database.  For this case we will use Entity Framework on top of SQL Server.</p>

<h3>Add Entity Framework 6</h3>

<p>Create a root folder named <code>Entities</code> and select it.
<img src="/assets/pictures/jimmy-mvc/EntitiesFolder.png" alt="Model"></p>

<p>Press Ctrl-Shift-A To add a new item.</p>

<p>Select Visual C#-&gt;Data-&gt; ADO.NET Entity Data Model And Name it &quot;Model&quot; </p>

<p><img src="/assets/pictures/jimmy-mvc/AddEntity.png" alt="Model"></p>

<p>Select Empty Code First model and then Finish</p>

<p><img src="/assets/pictures/jimmy-mvc/EmptyCodeFirst.png" alt="Model"></p>

<p>This will add the Entity Framework Nuget package to your project and Create a <code>Model.cs</code> file and update your <code>Web.config</code></p>

<p>Make sure the Entity Framework Nuget is up to date using Nuget Package Manager.</p>

<h3>DelegateDecompiler.EntityFramework</h3>

<p>Install <a href="https://www.nuget.org/packages/DelegateDecompiler.EntityFramework/0.16.0" title="Nuget">Nuget DelegateDecompiler.EntityFramework</a> See the <a href="https://github.com/hazzik/DelegateDecompiler" title="Delegate Decompile">github</a> page.
<img src="/assets/pictures/jimmy-mvc/DelegateDecompilerNuget.png" alt="Model"></p>

<p>This will give you the <code>Computed</code> attribute and improved linq operations with it.</p>

<h2>User</h2>

<p>Now add a new class in the Entities folder named User.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Entities</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">DelegateDecompiler</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="kt">int</span> <span class="n">UserId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">     [Display(Name = &quot;First Name&quot;)]</span>
</span><span class='line'>      <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstAndMiddleName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">     [Computed]</span>
</span><span class='line'>      <span class="k">public</span> <span class="kt">string</span> <span class="n">FullName</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">get</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">return</span> <span class="n">LastName</span> <span class="p">+</span> <span class="s">&quot;, &quot;</span> <span class="p">+</span> <span class="n">FirstAndMiddleName</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Compile. To Ensure the application builds.</p>

<p>Update <code>Model.cs</code> to add the DbSet for the User class and to not pluralize the table names:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Entities</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Data.Entity</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Data.Entity.ModelConfiguration.Conventions</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">Model</span> <span class="p">:</span> <span class="n">DbContext</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Your context has been configured to use a &#39;Model&#39; connection string from your application&#39;s </span>
</span><span class='line'>      <span class="c1">// configuration file (App.config or Web.config). By default, this connection string targets the </span>
</span><span class='line'>      <span class="c1">// &#39;JimmyMvc.Model&#39; database on your LocalDb instance. </span>
</span><span class='line'>      <span class="c1">// </span>
</span><span class='line'>      <span class="c1">// If you wish to target a different database and/or database provider, modify the &#39;Model&#39; </span>
</span><span class='line'>      <span class="c1">// connection string in the application configuration file.</span>
</span><span class='line'>      <span class="k">public</span> <span class="nf">Model</span><span class="p">()</span>
</span><span class='line'>              <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">nameOrConnectionString</span><span class="p">:</span> <span class="s">&quot;name=Model&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Add a DbSet for each entity type that you want to include in your model. For more information </span>
</span><span class='line'>      <span class="c1">// on configuring and using a Code First model, see http://go.microsoft.com/fwlink/?LinkId=390109.</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// public virtual DbSet&lt;MyEntity&gt; MyEntities { get; set; }</span>
</span><span class='line'>      <span class="k">public</span> <span class="k">virtual</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">Users</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">DbModelBuilder</span> <span class="n">aDbModelBuilder</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">aDbModelBuilder</span><span class="p">.</span><span class="n">Conventions</span><span class="p">.</span><span class="n">Remove</span><span class="p">&lt;</span><span class="n">PluralizingTableNameConvention</span><span class="p">&gt;();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Create Database Initializer</h2>

<p>Add a new class named <code>ModelInitializer</code> to the <code>Entities</code> Folder as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Entities</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">ModelInitializer</span> <span class="p">:</span> <span class="n">System</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">Entity</span><span class="p">.</span><span class="n">DropCreateDatabaseIfModelChanges</span><span class="p">&lt;</span><span class="n">Model</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Seed</span><span class="p">(</span><span class="n">Model</span> <span class="n">aModel</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">base</span><span class="p">.</span><span class="n">Seed</span><span class="p">(</span><span class="n">aModel</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="kt">var</span> <span class="n">users</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">new</span> <span class="n">User</span><span class="p">{</span><span class="n">FirstAndMiddleName</span><span class="p">=</span><span class="s">&quot;Carson&quot;</span>  <span class="p">,</span><span class="n">LastName</span><span class="p">=</span><span class="s">&quot;Alexander&quot;</span> <span class="p">},</span>
</span><span class='line'>              <span class="k">new</span> <span class="n">User</span><span class="p">{</span><span class="n">FirstAndMiddleName</span><span class="p">=</span><span class="s">&quot;Meredith&quot;</span><span class="p">,</span><span class="n">LastName</span><span class="p">=</span><span class="s">&quot;Alonso&quot;</span>    <span class="p">},</span>
</span><span class='line'>              <span class="k">new</span> <span class="n">User</span><span class="p">{</span><span class="n">FirstAndMiddleName</span><span class="p">=</span><span class="s">&quot;Arturo&quot;</span>  <span class="p">,</span><span class="n">LastName</span><span class="p">=</span><span class="s">&quot;Anand&quot;</span>     <span class="p">},</span>
</span><span class='line'>              <span class="k">new</span> <span class="n">User</span><span class="p">{</span><span class="n">FirstAndMiddleName</span><span class="p">=</span><span class="s">&quot;Gytis&quot;</span>   <span class="p">,</span><span class="n">LastName</span><span class="p">=</span><span class="s">&quot;Barzdukas&quot;</span> <span class="p">},</span>
</span><span class='line'>              <span class="k">new</span> <span class="n">User</span><span class="p">{</span><span class="n">FirstAndMiddleName</span><span class="p">=</span><span class="s">&quot;Yan&quot;</span>     <span class="p">,</span><span class="n">LastName</span><span class="p">=</span><span class="s">&quot;Li&quot;</span>        <span class="p">},</span>
</span><span class='line'>              <span class="k">new</span> <span class="n">User</span><span class="p">{</span><span class="n">FirstAndMiddleName</span><span class="p">=</span><span class="s">&quot;Peggy&quot;</span>   <span class="p">,</span><span class="n">LastName</span><span class="p">=</span><span class="s">&quot;Justice&quot;</span>   <span class="p">},</span>
</span><span class='line'>              <span class="k">new</span> <span class="n">User</span><span class="p">{</span><span class="n">FirstAndMiddleName</span><span class="p">=</span><span class="s">&quot;Laura&quot;</span>   <span class="p">,</span><span class="n">LastName</span><span class="p">=</span><span class="s">&quot;Norman&quot;</span>    <span class="p">},</span>
</span><span class='line'>              <span class="k">new</span> <span class="n">User</span><span class="p">{</span><span class="n">FirstAndMiddleName</span><span class="p">=</span><span class="s">&quot;Nino&quot;</span>    <span class="p">,</span><span class="n">LastName</span><span class="p">=</span><span class="s">&quot;Olivetto&quot;</span>  <span class="p">}</span>
</span><span class='line'>          <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">users</span><span class="p">.</span><span class="n">ForEach</span><span class="p">(</span><span class="n">aUser</span> <span class="p">=&gt;</span> <span class="n">aModel</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">aUser</span><span class="p">));</span>
</span><span class='line'>          <span class="n">aModel</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Tell Entity Framework to use your initializer class by adding the following to the <code>Global.asax.cs</code> file as shown and the proper using statments:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>   <span class="c1">// Set Database Initializer</span>
</span><span class='line'>  <span class="n">Database</span><span class="p">.</span><span class="n">SetInitializer</span><span class="p">&lt;</span><span class="n">Model</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">ModelInitializer</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>

<p>The intializer will execute on first use.  If you want the initializer to execute immediately add the following code in the <code>Global.asax.cs</code> following the above. </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>   <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">model</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Model</span><span class="p">())</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">model</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p><code>Global.asax.cs</code> should now be as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Infrastructure</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Entities</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Optimization</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Routing</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Data.Entity</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">MvcApplication</span> <span class="p">:</span> <span class="n">System</span><span class="p">.</span><span class="n">Web</span><span class="p">.</span><span class="n">HttpApplication</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">protected</span> <span class="k">void</span> <span class="nf">Application_Start</span><span class="p">()</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">AreaRegistration</span><span class="p">.</span><span class="n">RegisterAllAreas</span><span class="p">();</span>
</span><span class='line'>          <span class="n">FilterConfig</span><span class="p">.</span><span class="n">RegisterGlobalFilters</span><span class="p">(</span><span class="n">GlobalFilters</span><span class="p">.</span><span class="n">Filters</span><span class="p">);</span>
</span><span class='line'>          <span class="n">RouteConfig</span><span class="p">.</span><span class="n">RegisterRoutes</span><span class="p">(</span><span class="n">RouteTable</span><span class="p">.</span><span class="n">Routes</span><span class="p">);</span>
</span><span class='line'>          <span class="n">BundleConfig</span><span class="p">.</span><span class="n">RegisterBundles</span><span class="p">(</span><span class="n">BundleTable</span><span class="p">.</span><span class="n">Bundles</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Replace Default ViewEngine with Feature version</span>
</span><span class='line'>          <span class="n">ViewEngines</span><span class="p">.</span><span class="n">Engines</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
</span><span class='line'>          <span class="n">ViewEngines</span><span class="p">.</span><span class="n">Engines</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">FeatureRazorViewEngine</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Replace Default Controller factor with Feature version</span>
</span><span class='line'>          <span class="n">ControllerBuilder</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">SetControllerFactory</span><span class="p">(</span><span class="k">new</span> <span class="n">JimmyMvc</span><span class="p">.</span><span class="n">Infrastructure</span><span class="p">.</span><span class="n">ControllerFactory</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Set Database Initializer</span>
</span><span class='line'>          <span class="n">Database</span><span class="p">.</span><span class="n">SetInitializer</span><span class="p">&lt;</span><span class="n">Model</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">ModelInitializer</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">model</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Model</span><span class="p">())</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">model</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">force</span><span class="p">:</span> <span class="k">false</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Execute the application now.  And the database should be created and populated with data.</p>

<p><img src="/assets/pictures/jimmy-mvc/DatabaseCreated.png" alt="Database Created"></p>

<p><img src="/assets/pictures/jimmy-mvc/UserData.png" alt="Database Created"></p>

<p>Lets get started implementing our first Feature and building the infrastructure needed to support it.   </p>

<h2>Feature 1: Display the list of users ##</h2>

<p>The url for the Feature will be <code>/User/Index</code></p>

<p>We will store all of the Features in the Features folder organized by the Entity/Aggregate root of which they are associated. So add a <code>User</code> folder under the Features folder.</p>

<p><img src="/assets/pictures/jimmy-mvc/UserFolder.png" alt="Database Created"></p>

<p>Add a class named <code>Index</code> to the <code>User</code> folder.  This will contain the Features logic.</p>

<p>Add an <code>Index</code> view by right clicking on the <code>User</code> folder and selecting <code>Add-&gt;MVC 5 View Page (Razor)</code> </p>

<p>Nest the <code>Index.cshtml</code> file under the <code>Index.cs</code> file to keep the solution organized, using the <a href="https://visualstudiogallery.msdn.microsoft.com/3ebde8fb-26d8-4374-a0eb-1e4e2665070c">File Nesting</a> add-in. </p>

<p>Replace the default <code>index.cshtml</code> code with the following temporary code which is just used so we can see something when the view renders. We will update this later.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">&lt;</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="n">List</span> <span class="n">of</span> <span class="n">Users</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Add a link to the main menu in the <code>Features\Shared\_Layout.cshtml</code> to the Users page.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">&lt;</span><span class="n">li</span><span class="p">&gt;</span><span class="n">@Html</span><span class="p">.</span><span class="n">ActionLink</span><span class="p">(</span><span class="s">&quot;Users&quot;</span><span class="p">,</span> <span class="s">&quot;Index&quot;</span><span class="p">,</span> <span class="s">&quot;User&quot;</span><span class="p">)&lt;/</span><span class="n">li</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now add a controller to the Feature.</p>

<p>Nested inside the Index class add a controller.  </p>

<p>Given that each feature now represents a single url the name of the controller method no longer needs to correspond to the url as there can only be one method for <code>get</code> and one for <code>post</code> on each controller.  So we will name all of our methods &quot;Action&quot; and thus give us the opportunity to be more DRY.  A controller class now can represent a single url.  We will use this knowledge later when we create a <code>LinkBuilder</code> class.</p>

<p>Your <code>User\Index.cs</code> file should be as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Features.User</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">Index</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="k">class</span> <span class="nc">UiController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="k">virtual</span> <span class="n">ActionResult</span> <span class="nf">Action</span><span class="p">()</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Execute the app and attempt to navigate to the Users page. <img src="/assets/pictures/jimmy-mvc/UsersLink.png" alt="Users page"></p>

<p>You will get <code>The resource cannot be found.</code> error. This is because the controller can not be found using our Controller Factory.  The current factory is looking for a controller of type &quot;JimmyMvc.Features.User.UiController&quot; and an method named &quot;Index&quot;.</p>

<p>Our controllers fully qualified name is &quot;JimmyMvc.Features.User.Index+UiController&quot; because we have embedded it inside the feature.  So we either have to change the factory, or not embed the controller.  Having done this both ways I chose to embed the controller as this allows for a more <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a> solution.  Also the method we are looking for is always named <code>Action</code> we will address this also in the controller factory.</p>

<p>So let&#39;s update the factory.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc.Async</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Routing</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">ControllerFactory</span> <span class="p">:</span> <span class="n">DefaultControllerFactory</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">protected</span> <span class="k">override</span> <span class="n">Type</span> <span class="nf">GetControllerType</span><span class="p">(</span><span class="n">RequestContext</span> <span class="n">aRequestContext</span><span class="p">,</span> <span class="kt">string</span> <span class="n">aControllerName</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">action</span> <span class="p">=</span> <span class="n">aRequestContext</span><span class="p">.</span><span class="n">RouteData</span><span class="p">.</span><span class="n">GetRequiredString</span><span class="p">(</span><span class="n">valueName</span><span class="p">:</span> <span class="s">&quot;action&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">typeName</span> <span class="p">=</span> <span class="s">&quot;JimmyMvc.Features.&quot;</span> <span class="p">+</span> <span class="n">aControllerName</span> <span class="p">+</span> <span class="s">&quot;.&quot;</span> <span class="p">+</span> <span class="n">action</span> <span class="p">+</span> <span class="s">&quot;+UiController&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">System</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">Assembly</span> <span class="n">assembly</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">ControllerFactory</span><span class="p">).</span><span class="n">Assembly</span><span class="p">;</span>
</span><span class='line'>          <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="n">assembly</span><span class="p">.</span><span class="n">GetType</span><span class="p">(</span><span class="n">typeName</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">override</span> <span class="n">IController</span> <span class="nf">CreateController</span><span class="p">(</span><span class="n">RequestContext</span> <span class="n">aRequestContext</span><span class="p">,</span> <span class="kt">string</span> <span class="n">aControllerName</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">IController</span> <span class="n">controller</span> <span class="p">=</span> <span class="k">base</span><span class="p">.</span><span class="n">CreateController</span><span class="p">(</span><span class="n">aRequestContext</span><span class="p">,</span> <span class="n">aControllerName</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="nf">ReplaceActionInvoker</span><span class="p">(</span><span class="n">controller</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">private</span> <span class="n">IController</span> <span class="nf">ReplaceActionInvoker</span><span class="p">(</span><span class="n">IController</span> <span class="n">aController</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="kt">var</span> <span class="n">mvcController</span> <span class="p">=</span> <span class="n">aController</span> <span class="k">as</span> <span class="n">Controller</span><span class="p">;</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">mvcController</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">mvcController</span><span class="p">.</span><span class="n">ActionInvoker</span> <span class="p">=</span> <span class="k">new</span> <span class="n">FeatureActionInvoker</span><span class="p">();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">return</span> <span class="n">aController</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">class</span> <span class="nc">FeatureActionInvoker</span> <span class="p">:</span> <span class="n">AsyncControllerActionInvoker</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">protected</span> <span class="k">override</span> <span class="n">ActionDescriptor</span> <span class="nf">FindAction</span><span class="p">(</span><span class="n">ControllerContext</span> <span class="n">aControllerContext</span><span class="p">,</span> <span class="n">ControllerDescriptor</span> <span class="n">aControllerDescriptor</span><span class="p">,</span> <span class="kt">string</span> <span class="n">aActionName</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="n">FindAction</span><span class="p">(</span><span class="n">aControllerContext</span><span class="p">,</span> <span class="n">aControllerDescriptor</span><span class="p">,</span> <span class="n">actionName</span><span class="p">:</span> <span class="s">&quot;Action&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Executing the application and navigating to the home url (Home/Index) will now give &quot;The resource cannot be found.&quot; but when you manually enter /User/Index you should see the view page.</p>

<p>So let&#39;s fix the <code>Home/About</code>, <code>Home/Contact</code>, <code>Home/Index</code> Features </p>

<p>under <code>Features\Home</code> Create classes named <code>About</code>, <code>Contact</code> and <code>Index</code>.</p>

<p>Take the existing controller and split it up among the respective classes.</p>

<p>The Existing Controller: </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Features.Home</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">UiController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Index</span><span class="p">()</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">About</span><span class="p">()</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">ViewBag</span><span class="p">.</span><span class="n">Message</span> <span class="p">=</span> <span class="s">&quot;Your application description page.&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Contact</span><span class="p">()</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">ViewBag</span><span class="p">.</span><span class="n">Message</span> <span class="p">=</span> <span class="s">&quot;Your contact page.&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Split and change the method names to &quot;Action&quot;</p>

<p>Index.cs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Features.Home</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">Index</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="k">class</span> <span class="nc">UiController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Action</span><span class="p">()</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>About.cs</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Features.Home</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">About</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">class</span> <span class="nc">UiController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Action</span><span class="p">()</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">ViewBag</span><span class="p">.</span><span class="n">Message</span> <span class="p">=</span> <span class="s">&quot;Your application description page.&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Contact.cs</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Features.Home</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">Contact</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="k">class</span> <span class="nc">UiController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Action</span><span class="p">()</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">ViewBag</span><span class="p">.</span><span class="n">Message</span> <span class="p">=</span> <span class="s">&quot;Your contact page.&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>now delete the <code>Home\UiController.cs</code> file and nest all the cshtml files under there respective .cs files.</p>

<p>At this point, the site should function and all the pages should work as well.  This gives one a basic idea of the concept but much more is needed for your typical business application.   </p>

<p>The <code>User/Index</code> Feature needs to display the list of users vs the current temporary page.</p>

<h2>Add Nuget packages</h2>

<p>First we need to add the nuget packages we are going to use in our features.</p>

<h3>MoreLinq</h3>

<p>Add <a href="https://www.nuget.org/packages/morelinq/1.1.1/" title="Nuget">MoreLinq</a></p>

<h3>Mehdime.Entity ###F</h3>

<p>Add <a href="https://www.nuget.org/packages/Mehdime.Entity/" title="Nuget">Nuget Mehdime.Entity</a> See the <a href="https://github.com/mehdime/DbContextScope" title="DbContextScope">github</a> page.
This gives us a better way of handling the lifecycle of DbContexts</p>

<h3>DbContextFactory</h3>

<p>In the <code>Entities</code> folder create the <code>DbContextFactory</code> class as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Entities</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Data.Entity</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Mehdime.Entity</span><span class="p">;</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">DbContextFactory</span> <span class="p">:</span> <span class="n">IDbContextFactory</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="n">TDbContext</span> <span class="n">CreateDbContext</span><span class="p">&lt;</span><span class="n">TDbContext</span><span class="p">&gt;()</span> <span class="k">where</span> <span class="n">TDbContext</span> <span class="p">:</span> <span class="n">DbContext</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="k">new</span> <span class="nf">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">TDbContext</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h4>FluentValidation.MVC5</h4>

<p><a href="http://github.com/JeremySkinner/FluentValidation">FluentValidation.MVC5</a>
<img src="/assets/pictures/jimmy-mvc/FluentValidation.MVC5Nuget.png" alt="FluentValidation.MVC5 Nuget"></p>

<h4>lodash</h4>

<p><a href="https://lodash.com/">lodash</a>
<img src="/assets/pictures/jimmy-mvc/lodashNuget.png" alt="lodash Nuget"></p>

<p>this will add the loadash.js file to the <code>Scripts</code> directory.</p>

<h4>Modernizr</h4>

<p><a href="http://modernizr.com/">Modernizr</a>
<img src="/assets/pictures/jimmy-mvc/ModernizrNuget.png" alt="Modernizr Nuget"></p>

<h4>Microsoft ASP.NET MVC Futures</h4>

<p><a href="https://www.nuget.org/packages/Microsoft.AspNet.Mvc.Futures/">Microsoft ASP.NET MVC Futures 5.1.0-rc1</a>
<img src="/assets/pictures/jimmy-mvc/MicrosoftAspNetMvcFuturesNuget.png" alt="FluentValidation.MVC5 Nuget"></p>

<p>Check for updates on all nuget packages.  Do not include pre-release versions unless stated.  Build Run and confirm the site works.</p>

<h3>StructureMap.MVC5</h3>

<p>StructureMap is used as the Ioc container in this template.  It could be replaced with Unity or Ninject (samples to come later... maybe)</p>

<p><a href="https://www.nuget.org/packages/StructureMap.MVC5/3.1.1.134">StructureMap.MVC5</a>
<img src="/assets/pictures/jimmy-mvc/StructureMap.MVC5Nuget.png" alt="StructureMap.MVC5"></p>

<p>This adds 4 dependent packages and also adds the files displayed below.</p>

<p><img src="/assets/pictures/jimmy-mvc/StructureMap.MVC5Files.png" alt="StructureMap.MVC5"></p>

<p>Now run <code>Update-Package</code> to update to the latest version of the dependent packages.</p>

<p>Build and run now will give the following error:</p>

<p><code>An instance of IControllerFactory was found in the resolver as well as a custom registered provider in ControllerBuilder.GetControllerFactory. Please set only one or the other.</code></p>

<p>Now that we have a container we no longer need the explicit setting of the controller factory in <code>Global.asax.cs</code> file</p>

<p>So remove the line </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">ControllerBuilder</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">SetControllerFactory</span><span class="p">(</span><span class="k">new</span> <span class="n">JimmyMvc</span><span class="p">.</span><span class="n">Infrastructure</span><span class="p">.</span><span class="n">ControllerFactory</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>

<p>The app should now function again.</p>

<p>Note that a nuget called <a href="https://github.com/davidebbo/WebActivator">WebActivatorEx</a> was a dependency and was also installed. &quot;WebActivator is a NuGet package that allows other packages to easily bring in Startup and Shutdown code into a web application. This gives a much cleaner solution than having to modify global.asax with the startup logic from many packages&quot;</p>

<p>Thus the StructuremapMVC.cs file has a Start method that will execute when the site starts up.</p>

<h3>DeafultRegistry</h3>

<p>Update the constructor as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// --------------------------------------------------------------------------------------------------------------------</span>
</span><span class='line'><span class="c1">// &lt;copyright file=&quot;DefaultRegistry.cs&quot; company=&quot;Web Advanced&quot;&gt;</span>
</span><span class='line'><span class="c1">// Copyright 2012 Web Advanced (www.webadvanced.com)</span>
</span><span class='line'><span class="c1">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
</span><span class='line'><span class="c1">// you may not use this file except in compliance with the License.</span>
</span><span class='line'><span class="c1">// You may obtain a copy of the License at</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// http://www.apache.org/licenses/LICENSE-2.0</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Unless required by applicable law or agreed to in writing, software</span>
</span><span class='line'><span class="c1">// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
</span><span class='line'><span class="c1">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span><span class='line'><span class="c1">// See the License for the specific language governing permissions and</span>
</span><span class='line'><span class="c1">// limitations under the License.</span>
</span><span class='line'><span class="c1">// &lt;/copyright&gt;</span>
</span><span class='line'><span class="c1">// --------------------------------------------------------------------------------------------------------------------</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.DependencyResolution</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Entities</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">FluentValidation</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Infrastructure</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">StructureMap.Configuration.DSL</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">StructureMap.Graph</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">StructureMap.Pipeline</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">//using JimmyMvc.Infrastructure.Validation;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Mehdime.Entity</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">DefaultRegistry</span> <span class="p">:</span> <span class="n">Registry</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="cp">#region Constructors and Destructors</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="nf">DefaultRegistry</span><span class="p">()</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">Scan</span><span class="p">(</span>
</span><span class='line'>                          <span class="n">aAssemblyScanner</span> <span class="p">=&gt;</span>
</span><span class='line'>                          <span class="p">{</span>
</span><span class='line'>                              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">TheCallingAssembly</span><span class="p">();</span>
</span><span class='line'>                              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">WithDefaultConventions</span><span class="p">();</span>
</span><span class='line'>                              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">LookForRegistries</span><span class="p">();</span>
</span><span class='line'>                              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">AssemblyContainingType</span><span class="p">&lt;</span><span class="n">DefaultRegistry</span><span class="p">&gt;();</span>
</span><span class='line'>                              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">AddAllTypesOf</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IModelBinder</span><span class="p">));</span>
</span><span class='line'>                              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">AddAllTypesOf</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IModelBinderProvider</span><span class="p">));</span>
</span><span class='line'>                              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">With</span><span class="p">(</span><span class="k">new</span> <span class="n">ControllerConvention</span><span class="p">());</span>
</span><span class='line'>                          <span class="p">});</span>
</span><span class='line'>          <span class="n">For</span><span class="p">&lt;</span><span class="n">IControllerFactory</span><span class="p">&gt;().</span><span class="n">Use</span><span class="p">&lt;</span><span class="n">ControllerFactory</span><span class="p">&gt;();</span>
</span><span class='line'>          <span class="n">For</span><span class="p">&lt;</span><span class="n">ModelValidatorProvider</span><span class="p">&gt;().</span><span class="n">Use</span><span class="p">&lt;</span><span class="n">FluentValidationModelValidatorProvider</span><span class="p">&gt;();</span>
</span><span class='line'>          <span class="n">For</span><span class="p">&lt;</span><span class="n">IDbContextFactory</span><span class="p">&gt;().</span><span class="n">Use</span><span class="p">&lt;</span><span class="n">DbContextFactory</span><span class="p">&gt;().</span><span class="n">LifecycleIs</span><span class="p">&lt;</span><span class="n">ContainerLifecycle</span><span class="p">&gt;();</span>
</span><span class='line'>          <span class="n">For</span><span class="p">&lt;</span><span class="n">IDbContextScopeFactory</span><span class="p">&gt;().</span><span class="n">Use</span><span class="p">&lt;</span><span class="n">DbContextScopeFactory</span><span class="p">&gt;().</span><span class="n">LifecycleIs</span><span class="p">&lt;</span><span class="n">ContainerLifecycle</span><span class="p">&gt;();</span>
</span><span class='line'>          <span class="n">For</span><span class="p">&lt;</span><span class="n">IAmbientDbContextLocator</span><span class="p">&gt;().</span><span class="n">Use</span><span class="p">&lt;</span><span class="n">AmbientDbContextLocator</span><span class="p">&gt;().</span><span class="n">LifecycleIs</span><span class="p">&lt;</span><span class="n">ContainerLifecycle</span><span class="p">&gt;();</span>
</span><span class='line'>          <span class="c1">//For&lt;IValidatorFactory&gt;().Use&lt;StructureMapValidatorFactory&gt;();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="cp">#endregion</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>This will automatically look for Registries that we will create as we proceed.   We will use the Validation logic later.</p>

<h3>PagedList.MVC</h3>

<p><a href="https://www.nuget.org/packages/PagedList.Mvc/4.5.0">PagedList.MVC</a>
<img src="/assets/pictures/jimmy-mvc/PagedListMvcNuget.png" alt="PagedListMvcNuget"></p>

<p>This will also add a PagedList.css file to your project.</p>

<h3>Automapper.EF6</h3>

<p><a href="https://www.nuget.org/packages/AutoMapper.EF6/">Automapper.EF6</a>
<img src="/assets/pictures/jimmy-mvc/AutoMapper.EF6Nuget.png" alt="AutoMapper.EF6Nuget"></p>

<p>Again run <code>Update-Package</code></p>

<h4>Mapping Extensions</h4>

<p>The <a href="https://lostechies.com/jimmybogard/2015/05/05/cqrs-with-mediatr-and-automapper/">ProjectToPagedList</a> method used in this post is an extension method we will create now.</p>

<p>Create the <code>Mapping</code> folder under the Infrastructure folder</p>

<p><img src="/assets/pictures/jimmy-mvc/MappingFolder.png" alt="MediatRNuget"></p>

<p>Create <code>MapperExtensions.cs</code> in the <code>Mapping</code> folder as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.Mapping</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Data.Entity</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">AutoMapper.QueryableExtensions</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">DelegateDecompiler</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">DelegateDecompiler.EntityFramework</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">PagedList</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">MapperExtensions</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">TDestination</span><span class="p">&gt;&gt;</span> <span class="n">ProjectToListAsync</span><span class="p">&lt;</span><span class="n">TDestination</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IQueryable</span> <span class="n">aQueryable</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="k">await</span> <span class="n">aQueryable</span><span class="p">.</span><span class="n">ProjectTo</span><span class="p">&lt;</span><span class="n">TDestination</span><span class="p">&gt;().</span><span class="n">DecompileAsync</span><span class="p">().</span><span class="n">ToListAsync</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">TDestination</span><span class="p">&gt;</span> <span class="n">ProjectToQueryable</span><span class="p">&lt;</span><span class="n">TDestination</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IQueryable</span> <span class="n">aQueryable</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">aQueryable</span><span class="p">.</span><span class="n">ProjectTo</span><span class="p">&lt;</span><span class="n">TDestination</span><span class="p">&gt;().</span><span class="n">Decompile</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">IPagedList</span><span class="p">&lt;</span><span class="n">TDestination</span><span class="p">&gt;</span> <span class="n">ProjectToPagedList</span><span class="p">&lt;</span><span class="n">TDestination</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IQueryable</span> <span class="n">aQueryable</span><span class="p">,</span> <span class="kt">int</span> <span class="n">aPageNumber</span><span class="p">,</span> <span class="kt">int</span> <span class="n">aPageSize</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">aQueryable</span><span class="p">.</span><span class="n">ProjectTo</span><span class="p">&lt;</span><span class="n">TDestination</span><span class="p">&gt;().</span><span class="n">Decompile</span><span class="p">().</span><span class="n">ToPagedList</span><span class="p">(</span><span class="n">aPageNumber</span><span class="p">,</span> <span class="n">aPageSize</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TDestination</span><span class="p">&gt;</span> <span class="n">ProjectToSingleOrDefaultAsync</span><span class="p">&lt;</span><span class="n">TDestination</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IQueryable</span> <span class="n">aQueryable</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="k">await</span> <span class="n">aQueryable</span><span class="p">.</span><span class="n">ProjectTo</span><span class="p">&lt;</span><span class="n">TDestination</span><span class="p">&gt;().</span><span class="n">DecompileAsync</span><span class="p">().</span><span class="n">SingleOrDefaultAsync</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h4>AutoMapperRegistry</h4>

<p>We need to register the mappings with the Ioc Container.</p>

<p>Create the <code>AutoMapperRegistry</code> class in the Mapping folder as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.Mapping</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">AutoMapper</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">StructureMap.Configuration.DSL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">AutoMapperRegistry</span> <span class="p">:</span> <span class="n">Registry</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="nf">AutoMapperRegistry</span><span class="p">()</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">Scan</span><span class="p">(</span><span class="n">aAssemblyScanner</span> <span class="p">=&gt;</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">AssemblyContainingType</span><span class="p">&lt;</span><span class="n">AutoMapperRegistry</span><span class="p">&gt;();</span>
</span><span class='line'>              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">AddAllTypesOf</span><span class="p">&lt;</span><span class="n">Profile</span><span class="p">&gt;();</span>
</span><span class='line'>              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">WithDefaultConventions</span><span class="p">();</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3>AutoMapperBootstrap</h3>

<p>Under the Mapping folder create AutoMapperBootstrapper class as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.Mapping</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">AutoMapper</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">StructureMap</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">AutoMapperBootstrapper</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">private</span> <span class="k">static</span> <span class="kt">bool</span> <span class="n">initialized</span><span class="p">;</span>
</span><span class='line'>      <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">object</span> <span class="n">containerLock</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Initialize</span><span class="p">(</span><span class="n">IContainer</span> <span class="n">aContainer</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">lock</span> <span class="p">(</span><span class="n">containerLock</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(!</span><span class="n">initialized</span><span class="p">)</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">InitializeInternal</span><span class="p">(</span><span class="n">aContainer</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">initialized</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">InitializeInternal</span><span class="p">(</span><span class="n">IContainer</span> <span class="n">aContainer</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="c1">//var logger = Logger.Instance;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//logger.Debug(&quot;Initializing Automapper&quot;);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">Mapper</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">aConfiguration</span> <span class="p">=&gt;</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="kt">var</span> <span class="n">profileNames</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
</span><span class='line'>              <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">profile</span> <span class="k">in</span> <span class="n">aContainer</span><span class="p">.</span><span class="n">GetAllInstances</span><span class="p">&lt;</span><span class="n">Profile</span><span class="p">&gt;())</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">profileNames</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">profile</span><span class="p">.</span><span class="n">ProfileName</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">aConfiguration</span><span class="p">.</span><span class="n">AddProfile</span><span class="p">(</span><span class="n">profile</span><span class="p">);</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>              <span class="c1">//logger.Verbose(&quot;Added profiles: {ProfileName}&quot;, profileNames);</span>
</span><span class='line'>
</span><span class='line'>              <span class="n">aConfiguration</span><span class="p">.</span><span class="n">ConstructServicesUsing</span><span class="p">(</span><span class="n">aContainer</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">);</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3>StructuremapMvc</h3>

<p>Make sure AutomapperBootstrapper is intialized by updating the <code>App_Start/StructureMapMvc.cs</code> Start method to: </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>   <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">IContainer</span> <span class="n">container</span> <span class="p">=</span> <span class="n">IoC</span><span class="p">.</span><span class="n">Initialize</span><span class="p">();</span>
</span><span class='line'>      <span class="n">StructureMapDependencyScope</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StructureMapDependencyScope</span><span class="p">(</span><span class="n">container</span><span class="p">);</span>
</span><span class='line'>      <span class="n">DependencyResolver</span><span class="p">.</span><span class="n">SetResolver</span><span class="p">(</span><span class="n">StructureMapDependencyScope</span><span class="p">);</span>
</span><span class='line'>      <span class="n">DynamicModuleUtility</span><span class="p">.</span><span class="n">RegisterModule</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">StructureMapScopeModule</span><span class="p">));</span>
</span><span class='line'>      <span class="n">AutoMapperBootstrapper</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">StructureMapDependencyScope</span><span class="p">.</span><span class="n">Container</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> 

<p>add </p>

<p><code>using Infrastructure.Mapping;</code></p>

<h3>MediatR</h3>

<p><a href="https://www.nuget.org/packages/MediatR">MediatR</a> This blog we use the 2.0.2 version
<img src="/assets/pictures/jimmy-mvc/MediatRNuget.png" alt="MediatRNuget"></p>

<h3>HtmlTags Nuget</h3>

<p><a href="https://www.nuget.org/packages/HtmlTags/">HtmlTags</a>
<img src="/assets/pictures/jimmy-mvc/HtmlTagsNuget.png" alt="HtmlTags"></p>

<p>If you would like to learn and understand the benefits of HtmlTags read this excellent <a href="http://lostechies.com/jimmybogard/2013/07/18/conventional-html-in-asp-net-mvc-a-primer/">series of articles on LosTechies.com</a></p>

<p>Configure HtmlTags</p>

<p>Add the Tags folder under Infrastructure.</p>

<p><img src="/assets/pictures/jimmy-mvc/TagsFolder.png" alt="HtmlTags"></p>

<h4>HtmlTagExtensions</h4>

<p>In the <code>Tags</code> Folder create the <code>HtmlTagExtensions</code> class as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.Tags</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">HtmlTags</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">HtmlTagExtensions</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">HtmlTag</span> <span class="nf">AddPlaceholder</span><span class="p">(</span><span class="k">this</span> <span class="n">HtmlTag</span> <span class="n">aHtmlTag</span><span class="p">,</span> <span class="kt">string</span> <span class="n">aPlaceholder</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">aHtmlTag</span><span class="p">.</span><span class="n">Attr</span><span class="p">(</span><span class="n">attribute</span><span class="p">:</span> <span class="s">&quot;placeholder&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="n">aPlaceholder</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">HtmlTag</span> <span class="nf">AddPattern</span><span class="p">(</span><span class="k">this</span> <span class="n">HtmlTag</span> <span class="n">aHtmlTag</span><span class="p">,</span> <span class="kt">string</span> <span class="n">aPattern</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">HtmlTag</span> <span class="n">retVal</span> <span class="p">=</span> <span class="n">aHtmlTag</span><span class="p">.</span><span class="n">Data</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;pattern&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="n">aPattern</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">retVal</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">HtmlTag</span> <span class="nf">AutoCapitalize</span><span class="p">(</span><span class="k">this</span> <span class="n">HtmlTag</span> <span class="n">aHtmlTag</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">aHtmlTag</span><span class="p">.</span><span class="n">Data</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;autocapitalize&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="s">&quot;true&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3>EnumDropDownModifier</h3>

<p>This lets us easily create drop down lists from enums</p>

<p>In the <code>Tags</code> Folder create the <code>EnumDropDownModifier</code> class as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.Tags</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">HtmlTags</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">HtmlTags.Conventions</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">HtmlTags.Conventions.Elements</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">EnumDropDownModifier</span> <span class="p">:</span> <span class="n">IElementModifier</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Matches</span><span class="p">(</span><span class="n">ElementRequest</span> <span class="n">aElementRequest</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">aElementRequest</span><span class="p">.</span><span class="n">Accessor</span><span class="p">.</span><span class="n">PropertyType</span><span class="p">.</span><span class="n">IsEnum</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">void</span> <span class="nf">Modify</span><span class="p">(</span><span class="n">ElementRequest</span> <span class="n">aElementRequest</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">Type</span> <span class="n">enumType</span> <span class="p">=</span> <span class="n">aElementRequest</span><span class="p">.</span><span class="n">Accessor</span><span class="p">.</span><span class="n">PropertyType</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">aElementRequest</span><span class="p">.</span><span class="n">CurrentTag</span><span class="p">.</span><span class="n">RemoveAttr</span><span class="p">(</span><span class="n">attribute</span><span class="p">:</span> <span class="s">&quot;type&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">aElementRequest</span><span class="p">.</span><span class="n">CurrentTag</span><span class="p">.</span><span class="n">TagName</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="s">&quot;select&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">aElementRequest</span><span class="p">.</span><span class="n">CurrentTag</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="k">new</span> <span class="n">HtmlTag</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="s">&quot;option&quot;</span><span class="p">));</span>
</span><span class='line'>          <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="k">value</span> <span class="k">in</span> <span class="n">Enum</span><span class="p">.</span><span class="n">GetValues</span><span class="p">(</span><span class="n">enumType</span><span class="p">))</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">HtmlTag</span> <span class="n">optionTag</span> <span class="p">=</span>
</span><span class='line'>                  <span class="k">new</span> <span class="nf">HtmlTag</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="s">&quot;option&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">Value</span><span class="p">(</span><span class="k">value</span><span class="p">.</span><span class="n">ToString</span><span class="p">())</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">Text</span><span class="p">(</span><span class="n">Enum</span><span class="p">.</span><span class="n">GetName</span><span class="p">(</span><span class="n">enumType</span><span class="p">,</span> <span class="k">value</span><span class="p">));</span>
</span><span class='line'>              <span class="n">aElementRequest</span><span class="p">.</span><span class="n">CurrentTag</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">optionTag</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3>DefaultDisplayLabelBuilder</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.Tags</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Text.RegularExpressions</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">HtmlTags</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">HtmlTags.Conventions</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">HtmlTags.Conventions.Elements</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">DefaultDisplayLabelBuilder</span> <span class="p">:</span> <span class="n">IElementBuilder</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Matches</span><span class="p">(</span><span class="n">ElementRequest</span> <span class="n">aElementRequest</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="n">HtmlTag</span> <span class="nf">Build</span><span class="p">(</span><span class="n">ElementRequest</span> <span class="n">aElementRequest</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="k">new</span> <span class="nf">HtmlTag</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">).</span><span class="n">NoTag</span><span class="p">().</span><span class="n">Text</span><span class="p">(</span><span class="n">BreakUpCamelCase</span><span class="p">(</span><span class="n">aElementRequest</span><span class="p">.</span><span class="n">Accessor</span><span class="p">.</span><span class="n">Name</span><span class="p">));</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">BreakUpCamelCase</span><span class="p">(</span><span class="kt">string</span> <span class="n">aFieldName</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="kt">string</span><span class="p">[]</span> <span class="n">patterns</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>                              <span class="s">&quot;([a-z])([A-Z])&quot;</span><span class="p">,</span>
</span><span class='line'>                              <span class="s">&quot;([0-9])([a-zA-Z])&quot;</span><span class="p">,</span>
</span><span class='line'>                              <span class="s">&quot;([a-zA-Z])([0-9])&quot;</span>
</span><span class='line'>                      <span class="p">};</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">output</span> <span class="p">=</span> <span class="n">patterns</span><span class="p">.</span><span class="n">Aggregate</span><span class="p">(</span><span class="n">aFieldName</span><span class="p">,</span>
</span><span class='line'>                  <span class="p">(</span><span class="n">aCurrent</span><span class="p">,</span> <span class="n">aPattern</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">Regex</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="n">aCurrent</span><span class="p">,</span> <span class="n">aPattern</span><span class="p">,</span> <span class="n">replacement</span><span class="p">:</span> <span class="s">&quot;$1 $2&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">RegexOptions</span><span class="p">.</span><span class="n">IgnorePatternWhitespace</span><span class="p">));</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">output</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="n">oldChar</span><span class="p">:</span> <span class="sc">&#39;_&#39;</span><span class="p">,</span> <span class="n">newChar</span><span class="p">:</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3>DefaultAspNetMvcHtmlConventions</h3>

<p>This will set up our Default html conventions. </p>

<p>In the <code>Tags</code> Folder create the <code>DefaultAspNetMvcHtmlConventions</code> class</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.Tags</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Drawing</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">HtmlTags</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">HtmlTags.Conventions</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">HtmlTags.Conventions.Elements</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">HtmlTags.Reflection</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">DefaultAspNetMvcHtmlConventions</span> <span class="p">:</span> <span class="n">HtmlConventionRegistry</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="nf">DefaultAspNetMvcHtmlConventions</span><span class="p">()</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">Always</span><span class="p">.</span><span class="n">AddClass</span><span class="p">(</span><span class="n">className</span><span class="p">:</span> <span class="s">&quot;form-control&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Label</span>
</span><span class='line'>          <span class="n">Labels</span><span class="p">.</span><span class="n">Always</span><span class="p">.</span><span class="n">AddClass</span><span class="p">(</span><span class="n">className</span><span class="p">:</span> <span class="s">&quot;control-label&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">Labels</span><span class="p">.</span><span class="n">Always</span><span class="p">.</span><span class="n">AddClass</span><span class="p">(</span><span class="n">className</span><span class="p">:</span> <span class="s">&quot;col-md-2&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">Labels</span><span class="p">.</span><span class="n">ModifyForAttribute</span><span class="p">&lt;</span><span class="n">DisplayAttribute</span><span class="p">&gt;((</span><span class="n">aHtmlTag</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">aHtmlTag</span><span class="p">.</span><span class="n">Text</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">Name</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Checkbox</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">IfPropertyIs</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;().</span><span class="n">Attr</span><span class="p">(</span><span class="n">attName</span><span class="p">:</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="s">&quot;checkbox&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Color</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">IfPropertyIs</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;().</span><span class="n">Attr</span><span class="p">(</span><span class="n">attName</span><span class="p">:</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="s">&quot;color&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Date/Time/DateTime/Local DateTime</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">IfPropertyIs</span><span class="p">&lt;</span><span class="n">DateTime</span><span class="p">?&gt;().</span><span class="n">ModifyWith</span><span class="p">(</span><span class="n">aElementRequest</span> <span class="p">=&gt;</span> <span class="n">aElementRequest</span><span class="p">.</span><span class="n">CurrentTag</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">AddPattern</span><span class="p">(</span><span class="n">aPattern</span><span class="p">:</span> <span class="s">&quot;9{1,2}/9{1,2}/9999&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">AddPlaceholder</span><span class="p">(</span><span class="n">aPlaceholder</span><span class="p">:</span> <span class="s">&quot;MM/DD/YYYY&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">AddClass</span><span class="p">(</span><span class="n">className</span><span class="p">:</span> <span class="s">&quot;datepicker&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="p">.</span><span class="n">Value</span><span class="p">(</span><span class="n">aElementRequest</span><span class="p">.</span><span class="n">Value</span><span class="p">&lt;</span><span class="n">DateTime</span><span class="p">?&gt;()</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">?</span> <span class="n">aElementRequest</span><span class="p">.</span><span class="n">Value</span><span class="p">&lt;</span><span class="n">DateTime</span><span class="p">&gt;().</span><span class="n">ToShortDateString</span><span class="p">()</span> <span class="p">:</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">));</span>
</span><span class='line'>          <span class="n">Displays</span><span class="p">.</span><span class="n">IfPropertyIs</span><span class="p">&lt;</span><span class="n">DateTime</span><span class="p">&gt;().</span><span class="n">ModifyWith</span><span class="p">(</span><span class="n">aElementRequest</span> <span class="p">=&gt;</span> <span class="n">aElementRequest</span><span class="p">.</span><span class="n">CurrentTag</span><span class="p">.</span><span class="n">Text</span><span class="p">(</span><span class="n">aElementRequest</span><span class="p">.</span><span class="n">Value</span><span class="p">&lt;</span><span class="n">DateTime</span><span class="p">&gt;().</span><span class="n">ToShortDateString</span><span class="p">()));</span>
</span><span class='line'>          <span class="n">Displays</span><span class="p">.</span><span class="n">IfPropertyIs</span><span class="p">&lt;</span><span class="n">DateTime</span><span class="p">?&gt;().</span><span class="n">ModifyWith</span><span class="p">(</span><span class="n">aElementRequest</span> <span class="p">=&gt;</span> <span class="n">aElementRequest</span><span class="p">.</span><span class="n">CurrentTag</span><span class="p">.</span><span class="n">Text</span><span class="p">(</span><span class="n">aElementRequest</span><span class="p">.</span><span class="n">Value</span><span class="p">&lt;</span><span class="n">DateTime</span><span class="p">?&gt;()</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span> <span class="k">null</span> <span class="p">:</span> <span class="n">aElementRequest</span><span class="p">.</span><span class="n">Value</span><span class="p">&lt;</span><span class="n">DateTime</span><span class="p">?&gt;().</span><span class="n">Value</span><span class="p">.</span><span class="n">ToShortDateString</span><span class="p">()));</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Email</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">If</span><span class="p">(</span><span class="n">aElementRequest</span> <span class="p">=&gt;</span> <span class="n">aElementRequest</span><span class="p">.</span><span class="n">Accessor</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="k">value</span><span class="p">:</span> <span class="s">&quot;Email&quot;</span><span class="p">))</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">Attr</span><span class="p">(</span><span class="n">attName</span><span class="p">:</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="s">&quot;email&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Hidden</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">IfPropertyIs</span><span class="p">&lt;</span><span class="n">Guid</span><span class="p">&gt;().</span><span class="n">Attr</span><span class="p">(</span><span class="n">attName</span><span class="p">:</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="s">&quot;hidden&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">IfPropertyIs</span><span class="p">&lt;</span><span class="n">Guid</span><span class="p">?&gt;().</span><span class="n">Attr</span><span class="p">(</span><span class="n">attName</span><span class="p">:</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="s">&quot;hidden&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">IfPropertyHasAttribute</span><span class="p">&lt;</span><span class="n">HiddenInputAttribute</span><span class="p">&gt;().</span><span class="n">Attr</span><span class="p">(</span><span class="n">attName</span><span class="p">:</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="s">&quot;hidden&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Number</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">IfPropertyIs</span><span class="p">&lt;</span><span class="kt">decimal?</span><span class="p">&gt;().</span><span class="n">ModifyWith</span><span class="p">(</span><span class="n">aElementRequest</span> <span class="p">=&gt;</span> <span class="n">aElementRequest</span><span class="p">.</span><span class="n">CurrentTag</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">Data</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;pattern&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="s">&quot;9{1,9}.99&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">Data</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;placeholder&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="s">&quot;0.00&quot;</span><span class="p">));</span>
</span><span class='line'>          <span class="c1">//TODO int float</span>
</span><span class='line'>          <span class="n">Displays</span><span class="p">.</span><span class="n">IfPropertyIs</span><span class="p">&lt;</span><span class="kt">decimal</span><span class="p">&gt;().</span><span class="n">ModifyWith</span><span class="p">(</span><span class="n">aElementRequest</span> <span class="p">=&gt;</span> <span class="n">aElementRequest</span><span class="p">.</span><span class="n">CurrentTag</span><span class="p">.</span><span class="n">Text</span><span class="p">(</span><span class="n">aElementRequest</span><span class="p">.</span><span class="n">Value</span><span class="p">&lt;</span><span class="kt">decimal</span><span class="p">&gt;().</span><span class="n">ToString</span><span class="p">(</span><span class="n">format</span><span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">)));</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Password</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">If</span><span class="p">(</span><span class="n">aElementRequest</span> <span class="p">=&gt;</span> <span class="n">aElementRequest</span><span class="p">.</span><span class="n">Accessor</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="k">value</span><span class="p">:</span> <span class="s">&quot;Password&quot;</span><span class="p">))</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">Attr</span><span class="p">(</span><span class="n">attName</span><span class="p">:</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="s">&quot;password&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">If</span><span class="p">(</span><span class="n">aElementRequest</span> <span class="p">=&gt;</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">DataTypeAttribute</span> <span class="n">dataTypeAttribute</span> <span class="p">=</span> <span class="n">aElementRequest</span><span class="p">.</span><span class="n">Accessor</span><span class="p">.</span><span class="n">GetAttribute</span><span class="p">&lt;</span><span class="n">DataTypeAttribute</span><span class="p">&gt;();</span>
</span><span class='line'>              <span class="k">return</span> <span class="n">dataTypeAttribute</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">dataTypeAttribute</span><span class="p">.</span><span class="n">DataType</span> <span class="p">==</span> <span class="n">DataType</span><span class="p">.</span><span class="n">Password</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}).</span><span class="n">Attr</span><span class="p">(</span><span class="n">attName</span><span class="p">:</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="s">&quot;password&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Radio</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">Modifier</span><span class="p">&lt;</span><span class="n">EnumDropDownModifier</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Telephone</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">If</span><span class="p">(</span><span class="n">aElementRequest</span> <span class="p">=&gt;</span> <span class="n">aElementRequest</span><span class="p">.</span><span class="n">Accessor</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="k">value</span><span class="p">:</span> <span class="s">&quot;Phone&quot;</span><span class="p">))</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">Attr</span><span class="p">(</span><span class="n">attName</span><span class="p">:</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="s">&quot;tel&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">If</span><span class="p">(</span><span class="n">aElementRequest</span> <span class="p">=&gt;</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">DataTypeAttribute</span> <span class="n">dataTypeAttribute</span> <span class="p">=</span> <span class="n">aElementRequest</span><span class="p">.</span><span class="n">Accessor</span><span class="p">.</span><span class="n">GetAttribute</span><span class="p">&lt;</span><span class="n">DataTypeAttribute</span><span class="p">&gt;();</span>
</span><span class='line'>              <span class="k">return</span> <span class="n">dataTypeAttribute</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">dataTypeAttribute</span><span class="p">.</span><span class="n">DataType</span> <span class="p">==</span> <span class="n">DataType</span><span class="p">.</span><span class="n">PhoneNumber</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}).</span><span class="n">Attr</span><span class="p">(</span><span class="n">attName</span><span class="p">:</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="s">&quot;tel&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Text</span>
</span><span class='line'>          <span class="c1">// Default</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Url</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">If</span><span class="p">(</span><span class="n">aElementRequest</span> <span class="p">=&gt;</span> <span class="n">aElementRequest</span><span class="p">.</span><span class="n">Accessor</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="k">value</span><span class="p">:</span> <span class="s">&quot;Url&quot;</span><span class="p">))</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">Attr</span><span class="p">(</span><span class="n">attName</span><span class="p">:</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="s">&quot;url&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">If</span><span class="p">(</span><span class="n">aElementRequest</span> <span class="p">=&gt;</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">DataTypeAttribute</span> <span class="n">dataTypeAttribute</span> <span class="p">=</span> <span class="n">aElementRequest</span><span class="p">.</span><span class="n">Accessor</span><span class="p">.</span><span class="n">GetAttribute</span><span class="p">&lt;</span><span class="n">DataTypeAttribute</span><span class="p">&gt;();</span>
</span><span class='line'>              <span class="k">return</span> <span class="n">dataTypeAttribute</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">dataTypeAttribute</span><span class="p">.</span><span class="n">DataType</span> <span class="p">==</span> <span class="n">DataType</span><span class="p">.</span><span class="n">Url</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}).</span><span class="n">Attr</span><span class="p">(</span><span class="n">attName</span><span class="p">:</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="s">&quot;url&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Id</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">If</span><span class="p">(</span><span class="n">aElementRequest</span> <span class="p">=&gt;</span> <span class="n">aElementRequest</span><span class="p">.</span><span class="n">Accessor</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">EndsWith</span><span class="p">(</span><span class="k">value</span><span class="p">:</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">comparisonType</span><span class="p">:</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">)).</span><span class="n">BuildBy</span><span class="p">(</span><span class="n">a</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">HiddenTag</span><span class="p">().</span><span class="n">Value</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">StringValue</span><span class="p">()));</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//byte</span>
</span><span class='line'>          <span class="n">Editors</span><span class="p">.</span><span class="n">IfPropertyIs</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">[]&gt;().</span><span class="n">BuildBy</span><span class="p">(</span><span class="n">a</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">HiddenTag</span><span class="p">().</span><span class="n">Value</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="n">ToBase64String</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">Value</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">[]&gt;())));</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Domain Specific</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Editors.BuilderPolicy&lt;UserSelectElementBuilder&gt;();</span>
</span><span class='line'>          <span class="c1">//Editors.BuilderPolicy&lt;XXXSelectElementBuilder&gt;();</span>
</span><span class='line'>          <span class="n">DisplayLabels</span><span class="p">.</span><span class="n">Always</span><span class="p">.</span><span class="n">BuildBy</span><span class="p">&lt;</span><span class="n">DefaultDisplayLabelBuilder</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">DisplayLabels</span><span class="p">.</span><span class="n">ModifyForAttribute</span><span class="p">&lt;</span><span class="n">DisplayAttribute</span><span class="p">&gt;((</span><span class="n">aHtmlTag</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">aHtmlTag</span><span class="p">.</span><span class="n">Text</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">Name</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="n">ElementCategoryExpression</span> <span class="n">DisplayLabels</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="n">ElementCategoryExpression</span><span class="p">(</span><span class="n">Library</span><span class="p">.</span><span class="n">TagLibrary</span><span class="p">.</span><span class="n">Category</span><span class="p">(</span><span class="n">category</span><span class="p">:</span> <span class="s">&quot;DisplayLabels&quot;</span><span class="p">).</span><span class="n">Profile</span><span class="p">(</span><span class="n">TagConstants</span><span class="p">.</span><span class="n">Default</span><span class="p">));</span> <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h4>HtmlTagRegistry</h4>

<p>Register these conventions with IoC container</p>

<p>In the <code>Tags</code> folder create the <code>HtmlTagRegistry</code> class.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.Tags</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">using</span> <span class="nn">HtmlTags.Conventions</span><span class="p">;</span>
</span><span class='line'>    <span class="k">using</span> <span class="nn">StructureMap.Configuration.DSL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">class</span> <span class="nc">HtmlTagRegistry</span> <span class="p">:</span> <span class="n">Registry</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">public</span> <span class="nf">HtmlTagRegistry</span><span class="p">()</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>            <span class="kt">var</span> <span class="n">htmlConventionLibrary</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HtmlConventionLibrary</span><span class="p">();</span>
</span><span class='line'>            <span class="k">new</span> <span class="nf">DefaultAspNetMvcHtmlConventions</span><span class="p">().</span><span class="n">Apply</span><span class="p">(</span><span class="n">htmlConventionLibrary</span><span class="p">);</span>
</span><span class='line'>            <span class="k">new</span> <span class="nf">DefaultHtmlConventions</span><span class="p">().</span><span class="n">Apply</span><span class="p">(</span><span class="n">htmlConventionLibrary</span><span class="p">);</span>
</span><span class='line'>            <span class="n">For</span><span class="p">&lt;</span><span class="n">HtmlConventionLibrary</span><span class="p">&gt;().</span><span class="n">Use</span><span class="p">(</span><span class="n">htmlConventionLibrary</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Build and confirm app still runs properly.</p>

<h2>User/Index Feature</h2>

<p>The <code>User/Index</code> page will only implement the get/query portion of a feature.  The flow of this is Query-&gt;Handler-&gt;Result.</p>

<p>The <code>Result</code> is the Model portion of MVC.  The controller directs the incoming query to the Handler and sends the Result/Model to the View.</p>

<p>We will need to add <code>Query</code>, <code>Result</code> and <code>QueryHandler</code> classes to the <code>Index</code> Feature.</p>

<h4>User.Index.Query</h4>

<p>Create a nested <code>Query</code> class inside the <code>Index</code> class.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">Query</span> <span class="p">:</span> <span class="n">IRequest</span><span class="p">&lt;</span><span class="n">Result</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">string</span> <span class="n">SortOrder</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">string</span> <span class="n">CurrentFilter</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">string</span> <span class="n">SearchString</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">int?</span> <span class="n">Page</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>The query will facilitate sorting, paging and filtering of the User list.</p>

<h4>User.Index.Result</h4>

<p>Create a nested <code>Result</code> class inside the <code>Index</code> class.  This will be the model passed to the view.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">Result</span> <span class="p">:</span> <span class="n">IRequest</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">string</span> <span class="n">CurrentSort</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">string</span> <span class="n">NameSortParm</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">string</span> <span class="n">CurrentFilter</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">string</span> <span class="n">SearchString</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>          <span class="k">public</span> <span class="n">IPagedList</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">Users</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">public</span> <span class="kt">int</span> <span class="n">UserId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="na">             [Display(Name = &quot;First Name&quot;)]</span>
</span><span class='line'>              <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstAndMiddleName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>              <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h4>User.Index.UiController</h4>

<p>Update UiController.Action to now take the Query as a parameter.  The controller is now a very simple implementation of taking the Query and sending it to the QueryHandler and sending the result to the view.  The mediatR nuget package is made exactly to fill this need and is injected into the controller. </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">UiController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMediator</span> <span class="n">mediator</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="nf">UiController</span><span class="p">(</span><span class="n">IMediator</span> <span class="n">aMediator</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">mediator</span> <span class="p">=</span> <span class="n">aMediator</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="k">virtual</span> <span class="n">ActionResult</span> <span class="nf">Index</span><span class="p">(</span><span class="n">Query</span> <span class="n">aQuery</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">Result</span> <span class="n">result</span> <span class="p">=</span> <span class="n">mediator</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">aQuery</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Make sure to include the required using clauses.  Justcode or <code>ctrl.</code> will resolve them for you.</p>

<h4>CommandProcessingRegistry</h4>

<p>To use the Mediator we need to register the Mediator, Handlers and Validators with the Ioc container.</p>

<p>Under the <code>Infrastructure</code> folder create a <code>CommandProcessing</code> folder and in this create the following registry class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.CommandProcessing</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">FluentValidation</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">StructureMap.Configuration.DSL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">CommandProcessingRegistry</span> <span class="p">:</span> <span class="n">Registry</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="nf">CommandProcessingRegistry</span><span class="p">()</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">Scan</span><span class="p">(</span><span class="n">aAssemblyScanner</span> <span class="p">=&gt;</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">AssemblyContainingType</span><span class="p">&lt;</span><span class="n">IMediator</span><span class="p">&gt;();</span>
</span><span class='line'>              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">AssemblyContainingType</span><span class="p">&lt;</span><span class="n">CommandProcessingRegistry</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">AddAllTypesOf</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IRequestHandler</span><span class="p">&lt;,&gt;));</span>
</span><span class='line'>              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">AddAllTypesOf</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IAsyncRequestHandler</span><span class="p">&lt;,&gt;));</span>
</span><span class='line'>              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">AddAllTypesOf</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IValidator</span><span class="p">&lt;&gt;));</span>
</span><span class='line'>              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">WithDefaultConventions</span><span class="p">();</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">For</span><span class="p">&lt;</span><span class="n">SingleInstanceFactory</span><span class="p">&gt;().</span><span class="n">Use</span><span class="p">&lt;</span><span class="n">SingleInstanceFactory</span><span class="p">&gt;(</span><span class="n">aContext</span> <span class="p">=&gt;</span> <span class="n">aType</span> <span class="p">=&gt;</span> <span class="n">aContext</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">(</span><span class="n">aType</span><span class="p">));</span>
</span><span class='line'>          <span class="n">For</span><span class="p">&lt;</span><span class="n">MultiInstanceFactory</span><span class="p">&gt;().</span><span class="n">Use</span><span class="p">&lt;</span><span class="n">MultiInstanceFactory</span><span class="p">&gt;(</span><span class="n">aContext</span> <span class="p">=&gt;</span> <span class="n">aType</span> <span class="p">=&gt;</span> <span class="n">aContext</span><span class="p">.</span><span class="n">GetAllInstances</span><span class="p">(</span><span class="n">aType</span><span class="p">));</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> 

<h3>User.Index.QueryHandler</h3>

<p>Create a nested <code>QueryHandler</code> class inside the <code>Index</code> class.</p>

<p>This will build the Result object which will be passed to the View.  It should contain 100% of the information needed for the view.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>   <span class="k">public</span> <span class="k">class</span> <span class="nc">QueryHandler</span> <span class="p">:</span> <span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">Query</span><span class="p">,</span> <span class="n">Result</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">private</span> <span class="n">IDbContextScopeFactory</span> <span class="n">DbContextScopeFactory</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="nf">QueryHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">DbContextScopeFactory</span> <span class="p">=</span> <span class="n">aDbContextScopeFactory</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="n">Result</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">Query</span> <span class="n">aQuery</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Result</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">CurrentSort</span> <span class="p">=</span> <span class="n">aQuery</span><span class="p">.</span><span class="n">SortOrder</span><span class="p">,</span>
</span><span class='line'>                  <span class="n">NameSortParm</span> <span class="p">=</span> <span class="n">String</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">aQuery</span><span class="p">.</span><span class="n">SortOrder</span><span class="p">)</span> <span class="p">?</span> <span class="s">&quot;name_desc&quot;</span> <span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">aQuery</span><span class="p">.</span><span class="n">SearchString</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">aQuery</span><span class="p">.</span><span class="n">Page</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="k">else</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">aQuery</span><span class="p">.</span><span class="n">SearchString</span> <span class="p">=</span> <span class="n">aQuery</span><span class="p">.</span><span class="n">CurrentFilter</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>              <span class="n">result</span><span class="p">.</span><span class="n">CurrentFilter</span> <span class="p">=</span> <span class="n">aQuery</span><span class="p">.</span><span class="n">SearchString</span><span class="p">;</span>
</span><span class='line'>              <span class="n">result</span><span class="p">.</span><span class="n">SearchString</span> <span class="p">=</span> <span class="n">aQuery</span><span class="p">.</span><span class="n">SearchString</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">dbContextScope</span> <span class="p">=</span> <span class="n">DbContextScopeFactory</span><span class="p">.</span><span class="n">CreateReadOnly</span><span class="p">())</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">Model</span> <span class="n">model</span> <span class="p">=</span> <span class="n">dbContextScope</span><span class="p">.</span><span class="n">DbContexts</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">Model</span><span class="p">&gt;();</span>
</span><span class='line'>                  <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">users</span> <span class="p">=</span> <span class="k">from</span> <span class="n">s</span> <span class="k">in</span> <span class="n">model</span><span class="p">.</span><span class="n">Users</span> <span class="k">select</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>                  <span class="k">if</span> <span class="p">(!</span><span class="n">String</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">aQuery</span><span class="p">.</span><span class="n">SearchString</span><span class="p">))</span>
</span><span class='line'>                  <span class="p">{</span>
</span><span class='line'>                      <span class="n">users</span> <span class="p">=</span> <span class="n">users</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">aUser</span> <span class="p">=&gt;</span> <span class="n">aUser</span><span class="p">.</span><span class="n">LastName</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">aQuery</span><span class="p">.</span><span class="n">SearchString</span><span class="p">)</span> <span class="p">||</span> <span class="n">aUser</span><span class="p">.</span><span class="n">FirstAndMiddleName</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">aQuery</span><span class="p">.</span><span class="n">SearchString</span><span class="p">));</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>                  <span class="k">switch</span> <span class="p">(</span><span class="n">aQuery</span><span class="p">.</span><span class="n">SortOrder</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">{</span>
</span><span class='line'>                      <span class="k">case</span> <span class="s">&quot;name_desc&quot;</span><span class="p">:</span>
</span><span class='line'>                          <span class="n">users</span> <span class="p">=</span> <span class="n">users</span><span class="p">.</span><span class="n">OrderByDescending</span><span class="p">(</span><span class="n">aUser</span> <span class="p">=&gt;</span> <span class="n">aUser</span><span class="p">.</span><span class="n">LastName</span><span class="p">);</span>
</span><span class='line'>                          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                      <span class="k">default</span><span class="p">:</span> <span class="c1">// Name ascending </span>
</span><span class='line'>                          <span class="n">users</span> <span class="p">=</span> <span class="n">users</span><span class="p">.</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">aUser</span> <span class="p">=&gt;</span> <span class="n">aUser</span><span class="p">.</span><span class="n">LastName</span><span class="p">);</span>
</span><span class='line'>                          <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                  <span class="kt">int</span> <span class="n">pageSize</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
</span><span class='line'>                  <span class="kt">int</span> <span class="n">pageNumber</span> <span class="p">=</span> <span class="p">(</span><span class="n">aQuery</span><span class="p">.</span><span class="n">Page</span> <span class="p">??</span> <span class="m">1</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">result</span><span class="p">.</span><span class="n">Users</span> <span class="p">=</span> <span class="n">users</span><span class="p">.</span><span class="n">ProjectToPagedList</span><span class="p">&lt;</span><span class="n">Result</span><span class="p">.</span><span class="n">User</span><span class="p">&gt;(</span><span class="n">pageNumber</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h3>MappingProfile</h3>

<p>Automapper can be used to map between Domain entities and our Queries, Results and Commands. This mapping needs to be defined.</p>

<p>Please add a nested <code>MappingProfile</code> class inside the <code>Index</code> class as follows: </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>   <span class="k">public</span> <span class="k">class</span> <span class="nc">MappingProfile</span> <span class="p">:</span> <span class="n">Profile</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">()</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">CreateMap</span><span class="p">&lt;</span><span class="n">User</span><span class="p">,</span> <span class="n">Index</span><span class="p">.</span><span class="n">Result</span><span class="p">.</span><span class="n">User</span><span class="p">&gt;();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>So now that we have a model to submit to the view, let&#39;s update the view.</p>

<p>First we will need some Html Helper items</p>

<p>Create new <code>Extensions</code> folder under the <code>Infrastrcuture</code> Folder.</p>

<h3>LinkBuilder.cs</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.Extensions</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Routing</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">MoreLinq</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">LinkBuilder</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">GetNamesFromController</span><span class="p">&lt;</span><span class="n">TController</span><span class="p">&gt;(</span><span class="k">out</span> <span class="kt">string</span> <span class="n">aControllerName</span><span class="p">,</span> <span class="k">out</span> <span class="kt">string</span> <span class="n">aActionName</span><span class="p">)</span> <span class="k">where</span> <span class="n">TController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">fullname</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">TController</span><span class="p">).</span><span class="n">FullName</span><span class="p">;</span>                <span class="c1">//JimmyMvc.Features.User.Create+UiController</span>
</span><span class='line'>          <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">lastTwo</span> <span class="p">=</span> <span class="n">fullname</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">).</span><span class="n">TakeLast</span><span class="p">(</span><span class="m">2</span><span class="p">);</span> <span class="c1">// User, Create+UiController</span>
</span><span class='line'>          <span class="n">aControllerName</span> <span class="p">=</span> <span class="n">lastTwo</span><span class="p">.</span><span class="n">First</span><span class="p">();</span>                             <span class="c1">// User</span>
</span><span class='line'>          <span class="n">aActionName</span> <span class="p">=</span> <span class="n">lastTwo</span><span class="p">.</span><span class="n">Last</span><span class="p">().</span><span class="n">Split</span><span class="p">(</span><span class="sc">&#39;+&#39;</span><span class="p">).</span><span class="n">First</span><span class="p">();</span>               <span class="c1">// Create</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">BuildUrlForController</span><span class="p">&lt;</span><span class="n">TController</span><span class="p">&gt;(</span><span class="n">RequestContext</span> <span class="n">aRequestContext</span><span class="p">,</span> <span class="kt">object</span> <span class="n">aRouteValues</span><span class="p">)</span> <span class="k">where</span> <span class="n">TController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">controllerName</span><span class="p">;</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">actionName</span><span class="p">;</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">url</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">GetNamesFromController</span><span class="p">&lt;</span><span class="n">TController</span><span class="p">&gt;(</span><span class="k">out</span> <span class="n">controllerName</span><span class="p">,</span> <span class="k">out</span> <span class="n">actionName</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">aRouteValues</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">url</span> <span class="p">=</span> <span class="err">$</span><span class="s">&quot;{controllerName}/{actionName}&quot;</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="kt">var</span> <span class="n">routeValueDictionary</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RouteValueDictionary</span><span class="p">(</span><span class="n">aRouteValues</span><span class="p">);</span>
</span><span class='line'>              <span class="n">routeValueDictionary</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;Controller&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="n">controllerName</span><span class="p">);</span>
</span><span class='line'>              <span class="n">routeValueDictionary</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;Action&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="n">actionName</span><span class="p">);</span>
</span><span class='line'>              <span class="kt">var</span> <span class="n">urlHelper</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UrlHelper</span><span class="p">(</span><span class="n">aRequestContext</span><span class="p">);</span>
</span><span class='line'>              <span class="n">url</span> <span class="p">=</span> <span class="n">urlHelper</span><span class="p">.</span><span class="n">Action</span><span class="p">(</span><span class="n">actionName</span><span class="p">,</span> <span class="n">controllerName</span><span class="p">,</span> <span class="n">routeValueDictionary</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">url</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h4>HtmlHelperExtensions.cs</h4>

<p>We will be using some html helper extensions here also that will be shown following.  These use the HtmlTags to generate html.</p>

<p>Create <code>HtmlHelperExtensions</code> class under the Infrastructure folder</p>

<p><img src="/assets/pictures/jimmy-mvc/HtmlHelperExtensions.png" alt="MediatRNuget"></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.Extensions</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Linq.Expressions</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">MoreLinq</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc.Html</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Routing</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">App_Start</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">HtmlTags</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">HtmlTags.Conventions</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">HtmlTags.Conventions.Elements</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Microsoft.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">HtmlHelperExtensions</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">RequireJs</span><span class="p">(</span><span class="k">this</span> <span class="n">HtmlHelper</span> <span class="n">aHtmlHelper</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">RouteValueDictionary</span> <span class="n">values</span> <span class="p">=</span> <span class="n">aHtmlHelper</span><span class="p">.</span><span class="n">ViewContext</span><span class="p">.</span><span class="n">RouteData</span><span class="p">.</span><span class="n">Values</span><span class="p">;</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">controllerName</span> <span class="p">=</span> <span class="n">values</span><span class="p">[</span><span class="s">&quot;controller&quot;</span><span class="p">].</span><span class="n">ToString</span><span class="p">();</span>
</span><span class='line'>          <span class="kt">var</span> <span class="n">viewContext</span> <span class="p">=</span> <span class="p">(</span><span class="n">RazorView</span><span class="p">)</span><span class="n">aHtmlHelper</span><span class="p">.</span><span class="n">ViewContext</span><span class="p">.</span><span class="n">View</span><span class="p">;</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">viewName</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">GetFileNameWithoutExtension</span><span class="p">(</span><span class="n">viewContext</span><span class="p">.</span><span class="n">ViewPath</span><span class="p">);</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">requirePath</span> <span class="p">=</span> <span class="n">VirtualPathUtility</span><span class="p">.</span><span class="n">ToAbsolute</span><span class="p">(</span><span class="n">virtualPath</span><span class="p">:</span> <span class="s">&quot;~/Content/js/lib/require-2.1.18.js&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="kt">string</span> <span class="n">loc</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="n">format</span><span class="p">:</span> <span class="s">&quot;~/Features/{0}/{1}.js&quot;</span><span class="p">,</span> <span class="n">arg0</span><span class="p">:</span> <span class="n">controllerName</span><span class="p">,</span> <span class="n">arg1</span><span class="p">:</span> <span class="n">viewName</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">File</span><span class="p">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">aHtmlHelper</span><span class="p">.</span><span class="n">ViewContext</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">.</span><span class="n">Server</span><span class="p">.</span><span class="n">MapPath</span><span class="p">(</span><span class="n">loc</span><span class="p">)))</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="kt">string</span> <span class="n">scriptBlock</span> <span class="p">=</span> <span class="s">&quot;&lt;script data-main=&#39;{0}&#39; src=&#39;{1}&#39;&gt;&lt;/script&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="n">scriptBlock</span><span class="p">,</span> <span class="n">VirtualPathUtility</span><span class="p">.</span><span class="n">ToAbsolute</span><span class="p">(</span><span class="n">loc</span><span class="p">),</span> <span class="n">requirePath</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">HtmlTag</span> <span class="n">Input</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">HtmlHelper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">aHtmlHelper</span><span class="p">,</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">aExpression</span><span class="p">)</span>
</span><span class='line'>              <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
</span><span class='line'>      <span class="err">{</span>
</span><span class='line'>          <span class="n">IElementGenerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">generator</span> <span class="p">=</span> <span class="n">GetGenerator</span><span class="p">(</span><span class="n">aHtmlHelper</span><span class="p">.</span><span class="n">ViewData</span><span class="p">.</span><span class="n">Model</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">generator</span><span class="p">.</span><span class="n">InputFor</span><span class="p">(</span><span class="n">aExpression</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">HtmlTag</span> <span class="n">Label</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">HtmlHelper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">aHtmlHelper</span><span class="p">,</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">aExpression</span><span class="p">)</span>
</span><span class='line'>              <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
</span><span class='line'>      <span class="err">{</span>
</span><span class='line'>          <span class="n">IElementGenerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">generator</span> <span class="p">=</span> <span class="n">GetGenerator</span><span class="p">(</span><span class="n">aHtmlHelper</span><span class="p">.</span><span class="n">ViewData</span><span class="p">.</span><span class="n">Model</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">generator</span><span class="p">.</span><span class="n">LabelFor</span><span class="p">(</span><span class="n">aExpression</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">HtmlTag</span> <span class="n">Display</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">HtmlHelper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">aHtmlHelper</span><span class="p">,</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">aExpression</span><span class="p">)</span>
</span><span class='line'>              <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
</span><span class='line'>      <span class="err">{</span>
</span><span class='line'>          <span class="n">IElementGenerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">generator</span> <span class="p">=</span> <span class="n">GetGenerator</span><span class="p">(</span><span class="n">aHtmlHelper</span><span class="p">.</span><span class="n">ViewData</span><span class="p">.</span><span class="n">Model</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">generator</span><span class="p">.</span><span class="n">DisplayFor</span><span class="p">(</span><span class="n">aExpression</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">HtmlTag</span> <span class="n">DisplayLabel</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">HtmlHelper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">aHtmlHelper</span><span class="p">,</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">aExpression</span><span class="p">)</span>
</span><span class='line'>              <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
</span><span class='line'>      <span class="err">{</span>
</span><span class='line'>          <span class="n">IElementGenerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">generator</span> <span class="p">=</span> <span class="n">GetGenerator</span><span class="p">(</span><span class="n">aHtmlHelper</span><span class="p">.</span><span class="n">ViewData</span><span class="p">.</span><span class="n">Model</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">generator</span><span class="p">.</span><span class="n">TagFor</span><span class="p">(</span><span class="n">aExpression</span><span class="p">,</span> <span class="n">category</span><span class="p">:</span> <span class="s">&quot;DisplayLabels&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">HtmlTag</span> <span class="n">DisplayLabel</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">HtmlHelper</span><span class="p">&lt;</span><span class="n">IList</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">aHtmlHelper</span><span class="p">,</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">aExpression</span><span class="p">)</span>
</span><span class='line'>              <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
</span><span class='line'>      <span class="err">{</span>
</span><span class='line'>          <span class="n">IElementGenerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">generator</span> <span class="p">=</span> <span class="n">GetGenerator</span><span class="p">(</span><span class="k">default</span><span class="p">(</span><span class="n">T</span><span class="p">));</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">generator</span><span class="p">.</span><span class="n">TagFor</span><span class="p">(</span><span class="n">aExpression</span><span class="p">,</span> <span class="n">category</span><span class="p">:</span> <span class="s">&quot;DisplayLabels&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">MvcHtmlString</span> <span class="n">DisplayNameFor</span><span class="p">&lt;</span><span class="n">TModel</span><span class="p">,</span> <span class="n">TValue</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">HtmlHelper</span><span class="p">&lt;</span><span class="n">IList</span><span class="p">&lt;</span><span class="n">TModel</span><span class="p">&gt;&gt;</span> <span class="n">aHtmlHelper</span><span class="p">,</span>
</span><span class='line'>              <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">TModel</span><span class="p">,</span> <span class="n">TValue</span><span class="p">&gt;&gt;</span> <span class="n">aExpression</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="k">new</span> <span class="n">HtmlHelper</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">TModel</span><span class="p">&gt;&gt;(</span><span class="n">aHtmlHelper</span><span class="p">.</span><span class="n">ViewContext</span><span class="p">,</span> <span class="n">aHtmlHelper</span><span class="p">.</span><span class="n">ViewDataContainer</span><span class="p">).</span><span class="n">DisplayNameFor</span><span class="p">(</span><span class="n">aExpression</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">HtmlTag</span> <span class="n">InputBlock</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">HtmlHelper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">aHtmlHelper</span><span class="p">,</span>
</span><span class='line'>              <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">aExpression</span><span class="p">,</span>
</span><span class='line'>              <span class="n">Action</span><span class="p">&lt;</span><span class="n">HtmlTag</span><span class="p">&gt;</span> <span class="n">aInputModifier</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
</span><span class='line'>      <span class="err">{</span>
</span><span class='line'>          <span class="n">aInputModifier</span> <span class="p">=</span> <span class="n">aInputModifier</span> <span class="p">??</span> <span class="p">(</span><span class="n">aHtmlTag</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>          <span class="kt">var</span> <span class="n">divTag</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HtmlTag</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="s">&quot;div&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">divTag</span><span class="p">.</span><span class="n">AddClass</span><span class="p">(</span><span class="n">className</span><span class="p">:</span> <span class="s">&quot;col-md-10&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">HtmlTag</span> <span class="n">inputTag</span> <span class="p">=</span> <span class="n">aHtmlHelper</span><span class="p">.</span><span class="n">Input</span><span class="p">(</span><span class="n">aExpression</span><span class="p">);</span>
</span><span class='line'>          <span class="n">aInputModifier</span><span class="p">(</span><span class="n">inputTag</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">divTag</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">inputTag</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">return</span> <span class="n">divTag</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">HtmlTag</span> <span class="n">FormBlock</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">HtmlHelper</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">aHtmlHelper</span><span class="p">,</span>
</span><span class='line'>              <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">aExpression</span><span class="p">,</span>
</span><span class='line'>              <span class="n">Action</span><span class="p">&lt;</span><span class="n">HtmlTag</span><span class="p">&gt;</span> <span class="n">aLabelModifier</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>              <span class="n">Action</span><span class="p">&lt;</span><span class="n">HtmlTag</span><span class="p">&gt;</span> <span class="n">aInputBlockModifier</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>              <span class="n">Action</span><span class="p">&lt;</span><span class="n">HtmlTag</span><span class="p">&gt;</span> <span class="n">aInputModifier</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>              <span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
</span><span class='line'>      <span class="err">{</span>
</span><span class='line'>          <span class="n">aLabelModifier</span> <span class="p">=</span> <span class="n">aLabelModifier</span> <span class="p">??</span> <span class="p">(</span><span class="n">aHtmlTag</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">});</span>
</span><span class='line'>          <span class="n">aInputBlockModifier</span> <span class="p">=</span> <span class="n">aInputBlockModifier</span> <span class="p">??</span> <span class="p">(</span><span class="n">aHtmlTag</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>          <span class="kt">var</span> <span class="n">divTag</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HtmlTag</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="s">&quot;div&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="n">divTag</span><span class="p">.</span><span class="n">AddClass</span><span class="p">(</span><span class="n">className</span><span class="p">:</span> <span class="s">&quot;form-group&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">HtmlTag</span> <span class="n">labelTag</span> <span class="p">=</span> <span class="n">aHtmlHelper</span><span class="p">.</span><span class="n">Label</span><span class="p">(</span><span class="n">aExpression</span><span class="p">);</span>
</span><span class='line'>          <span class="n">aLabelModifier</span><span class="p">(</span><span class="n">labelTag</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">HtmlTag</span> <span class="n">inputBlockTag</span> <span class="p">=</span> <span class="n">aHtmlHelper</span><span class="p">.</span><span class="n">InputBlock</span><span class="p">(</span>
</span><span class='line'>                  <span class="n">aExpression</span><span class="p">,</span>
</span><span class='line'>                  <span class="n">aInputModifier</span><span class="p">);</span>
</span><span class='line'>          <span class="n">aInputBlockModifier</span><span class="p">(</span><span class="n">inputBlockTag</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">divTag</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">labelTag</span><span class="p">);</span>
</span><span class='line'>          <span class="n">divTag</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">inputBlockTag</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">return</span> <span class="n">divTag</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">HtmlTag</span> <span class="nf">ValidationDiv</span><span class="p">(</span><span class="k">this</span> <span class="n">HtmlHelper</span> <span class="n">aHtmlHelper</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="k">new</span> <span class="nf">HtmlTag</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="s">&quot;div&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">Id</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="s">&quot;validationSummary&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">AddClass</span><span class="p">(</span><span class="n">className</span><span class="p">:</span> <span class="s">&quot;alert&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">AddClass</span><span class="p">(</span><span class="n">className</span><span class="p">:</span> <span class="s">&quot;alert-danger&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">.</span><span class="n">AddClass</span><span class="p">(</span><span class="n">className</span><span class="p">:</span> <span class="s">&quot;hidden&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">HtmlTag</span> <span class="n">FeatureLink</span><span class="p">&lt;</span><span class="n">TController</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">HtmlHelper</span> <span class="n">aHtmlHelper</span><span class="p">,</span> <span class="kt">string</span> <span class="n">aLinkText</span><span class="p">)</span> <span class="k">where</span> <span class="n">TController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">controllerName</span><span class="p">,</span> <span class="n">actionName</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">LinkBuilder</span><span class="p">.</span><span class="n">GetNamesFromController</span><span class="p">&lt;</span><span class="n">TController</span><span class="p">&gt;(</span><span class="k">out</span> <span class="n">controllerName</span><span class="p">,</span> <span class="k">out</span> <span class="n">actionName</span><span class="p">);</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">url</span> <span class="p">=</span> <span class="err">$</span><span class="s">&quot;{controllerName}/{actionName}&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">return</span> <span class="nf">Link</span><span class="p">(</span><span class="n">aHtmlHelper</span><span class="p">,</span> <span class="n">aLinkText</span><span class="p">,</span> <span class="n">url</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">HtmlTag</span> <span class="n">FeatureLink</span><span class="p">&lt;</span><span class="n">TController</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">HtmlHelper</span> <span class="n">aHtmlHelper</span><span class="p">,</span> <span class="kt">string</span> <span class="n">aLinkText</span><span class="p">,</span> <span class="kt">object</span> <span class="n">aRouteValues</span><span class="p">)</span> <span class="k">where</span> <span class="n">TController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">controllerName</span><span class="p">,</span> <span class="n">actionName</span><span class="p">;</span>
</span><span class='line'>          <span class="n">LinkBuilder</span><span class="p">.</span><span class="n">GetNamesFromController</span><span class="p">&lt;</span><span class="n">TController</span><span class="p">&gt;(</span><span class="k">out</span> <span class="n">controllerName</span><span class="p">,</span> <span class="k">out</span> <span class="n">actionName</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="kt">var</span> <span class="n">routeValueDictionary</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RouteValueDictionary</span><span class="p">(</span><span class="n">aRouteValues</span><span class="p">);</span>
</span><span class='line'>          <span class="n">routeValueDictionary</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;Controller&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="n">controllerName</span><span class="p">);</span>
</span><span class='line'>          <span class="n">routeValueDictionary</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;Action&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="n">actionName</span><span class="p">);</span>
</span><span class='line'>          <span class="kt">var</span> <span class="n">urlHelper</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UrlHelper</span><span class="p">(</span><span class="n">aHtmlHelper</span><span class="p">.</span><span class="n">ViewContext</span><span class="p">.</span><span class="n">RequestContext</span><span class="p">);</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">url</span> <span class="p">=</span> <span class="n">urlHelper</span><span class="p">.</span><span class="n">Action</span><span class="p">(</span><span class="n">actionName</span><span class="p">,</span> <span class="n">controllerName</span><span class="p">,</span> <span class="n">routeValueDictionary</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">return</span> <span class="nf">Link</span><span class="p">(</span><span class="n">aHtmlHelper</span><span class="p">,</span> <span class="n">aLinkText</span><span class="p">,</span> <span class="n">url</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">private</span> <span class="k">static</span> <span class="n">HtmlTag</span> <span class="nf">Link</span><span class="p">(</span><span class="n">HtmlHelper</span> <span class="n">aHtmlHelper</span><span class="p">,</span> <span class="kt">string</span> <span class="n">aLinkText</span><span class="p">,</span> <span class="kt">string</span> <span class="n">aUrl</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">aUrl</span> <span class="p">=</span> <span class="s">&quot;~/&quot;</span> <span class="p">+</span> <span class="n">aUrl</span><span class="p">;</span>
</span><span class='line'>          <span class="n">aUrl</span> <span class="p">=</span> <span class="n">UrlHelper</span><span class="p">.</span><span class="n">GenerateContentUrl</span><span class="p">(</span><span class="n">aUrl</span><span class="p">,</span> <span class="n">aHtmlHelper</span><span class="p">.</span><span class="n">ViewContext</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">return</span> <span class="k">new</span> <span class="nf">HtmlTag</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="n">configure</span><span class="p">:</span> <span class="n">aHtmlTag</span> <span class="p">=&gt;</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">aHtmlTag</span><span class="p">.</span><span class="n">Text</span><span class="p">(</span><span class="n">aLinkText</span><span class="p">);</span>
</span><span class='line'>              <span class="n">aHtmlTag</span><span class="p">.</span><span class="n">Attr</span><span class="p">(</span><span class="n">attribute</span><span class="p">:</span> <span class="s">&quot;href&quot;</span><span class="p">,</span> <span class="k">value</span><span class="p">:</span> <span class="n">aUrl</span><span class="p">);</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">private</span> <span class="k">static</span> <span class="n">IElementGenerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetGenerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">aModel</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
</span><span class='line'>      <span class="err">{</span>
</span><span class='line'>          <span class="n">HtmlConventionLibrary</span> <span class="n">library</span> <span class="p">=</span> <span class="n">StructuremapMvc</span><span class="p">.</span><span class="n">StructureMapDependencyScope</span><span class="p">.</span><span class="n">CurrentNestedContainer</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">HtmlConventionLibrary</span><span class="p">&gt;();</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">ElementGenerator</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">For</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="n">aType</span> <span class="p">=&gt;</span> <span class="n">StructuremapMvc</span><span class="p">.</span><span class="n">StructureMapDependencyScope</span><span class="p">.</span><span class="n">CurrentNestedContainer</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">(</span><span class="n">aType</span><span class="p">),</span> <span class="n">aModel</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>In <code>Features\Web.config</code> make sure you add</p>

<p><code>&lt;add namespace=&quot;JimmyMvc.Infrastructure.Extensions&quot; /&gt;</code></p>

<p>in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>  <span class="nt">&lt;system.web.webPages.razor&gt;</span>
</span><span class='line'>    <span class="nt">&lt;host</span> <span class="na">factoryType=</span><span class="s">&quot;System.Web.Mvc.MvcWebRazorHostFactory, System.Web.Mvc, Version=5.2.2.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;pages</span> <span class="na">pageBaseType=</span><span class="s">&quot;System.Web.Mvc.WebViewPage&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;namespaces&gt;</span>
</span><span class='line'>        <span class="nt">&lt;add</span> <span class="na">namespace=</span><span class="s">&quot;System.Web.Mvc&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;add</span> <span class="na">namespace=</span><span class="s">&quot;System.Web.Mvc.Ajax&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;add</span> <span class="na">namespace=</span><span class="s">&quot;System.Web.Mvc.Html&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;add</span> <span class="na">namespace=</span><span class="s">&quot;System.Web.Optimization&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;add</span> <span class="na">namespace=</span><span class="s">&quot;System.Web.Routing&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;add</span> <span class="na">namespace=</span><span class="s">&quot;JimmyMvc&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;add</span> <span class="na">namespace=</span><span class="s">&quot;JimmyMvc.Infrastructure.Extensions&quot;</span> <span class="nt">/&gt;</span>               
</span><span class='line'>      <span class="nt">&lt;/namespaces&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/pages&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/system.web.webPages.razor&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>This will make the extension available for all views.</p>

<h2>UrlHelperExtensions</h2>

<p>Create class <code>UrlHelperExtensions</code> in the <code>Infrastructure/Extensions</code> Folder as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.Extensions</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Linq.Expressions</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Routing</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">UrlHelperExtensions</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">Feature</span><span class="p">&lt;</span><span class="n">TController</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">UrlHelper</span> <span class="n">aUrlHelper</span><span class="p">,</span> <span class="n">Object</span> <span class="n">aRouteValues</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>          <span class="k">where</span> <span class="n">TController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">url</span> <span class="p">=</span> <span class="n">LinkBuilder</span><span class="p">.</span><span class="n">BuildUrlForController</span><span class="p">&lt;</span><span class="n">TController</span><span class="p">&gt;(</span><span class="n">aUrlHelper</span><span class="p">.</span><span class="n">RequestContext</span><span class="p">,</span> <span class="n">aRouteValues</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">return</span> <span class="n">UrlHelper</span><span class="p">.</span><span class="n">GenerateContentUrl</span><span class="p">(</span><span class="s">&quot;~/&quot;</span> <span class="p">+</span> <span class="n">url</span><span class="p">,</span> <span class="n">aUrlHelper</span><span class="p">.</span><span class="n">RequestContext</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>One of the nice things about the extensions are the elimination of magic strings in your cshtml and they give you compile time type checking.</p>

<h3>_Layout.cshtml</h3>

<p>As an example lets update the _Layout.cshtml file replacing the ActionLink that uses magic strings with FeatureLink:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">@using</span> <span class="n">Home</span> <span class="p">=</span> <span class="n">JimmyMvc</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="n">Home</span>
</span><span class='line'><span class="n">@using</span> <span class="n">User</span> <span class="p">=</span> <span class="n">JimmyMvc</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="n">User</span>
</span><span class='line'><span class="p">&lt;!</span><span class="n">DOCTYPE</span> <span class="n">html</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">&lt;</span><span class="n">html</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">&lt;</span><span class="n">head</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="p">&lt;</span><span class="n">meta</span> <span class="n">charset</span><span class="p">=</span><span class="s">&quot;utf-8&quot;</span> <span class="p">/&gt;</span>
</span><span class='line'>    <span class="p">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="p">=</span><span class="s">&quot;viewport&quot;</span> <span class="n">content</span><span class="p">=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="p">&lt;</span><span class="n">title</span><span class="p">&gt;</span><span class="n">@ViewBag</span><span class="p">.</span><span class="n">Title</span> <span class="p">-</span> <span class="n">My</span> <span class="n">ASP</span><span class="p">.</span><span class="n">NET</span> <span class="n">Application</span><span class="p">&lt;/</span><span class="n">title</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="n">@Styles</span><span class="p">.</span><span class="n">Render</span><span class="p">(</span><span class="s">&quot;~/Content/css&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">@Scripts</span><span class="p">.</span><span class="n">Render</span><span class="p">(</span><span class="s">&quot;~/bundles/modernizr&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">head</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">&lt;</span><span class="n">body</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="p">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;navbar navbar-inverse navbar-fixed-top&quot;</span><span class="p">&gt;</span>
</span><span class='line'>        <span class="p">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>
</span><span class='line'>            <span class="p">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;navbar-header&quot;</span><span class="p">&gt;</span>
</span><span class='line'>                <span class="p">&lt;</span><span class="n">button</span> <span class="n">type</span><span class="p">=</span><span class="s">&quot;button&quot;</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;navbar-toggle&quot;</span> <span class="n">data</span><span class="p">-</span><span class="n">toggle</span><span class="p">=</span><span class="s">&quot;collapse&quot;</span> <span class="n">data</span><span class="p">-</span><span class="n">target</span><span class="p">=</span><span class="s">&quot;.navbar-collapse&quot;</span><span class="p">&gt;</span>
</span><span class='line'>                    <span class="p">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;icon-bar&quot;</span><span class="p">&gt;&lt;/</span><span class="n">span</span><span class="p">&gt;</span>
</span><span class='line'>                    <span class="p">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;icon-bar&quot;</span><span class="p">&gt;&lt;/</span><span class="n">span</span><span class="p">&gt;</span>
</span><span class='line'>                    <span class="p">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;icon-bar&quot;</span><span class="p">&gt;&lt;/</span><span class="n">span</span><span class="p">&gt;</span>
</span><span class='line'>                <span class="p">&lt;/</span><span class="n">button</span><span class="p">&gt;</span>
</span><span class='line'>              <span class="err">@</span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">FeatureLink</span><span class="p">&lt;</span><span class="n">Home</span><span class="p">.</span><span class="n">Index</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;(</span><span class="n">aLinkText</span><span class="p">:</span> <span class="s">&quot;Application name&quot;</span><span class="p">).</span><span class="n">AddClass</span><span class="p">(</span><span class="s">&quot;navbar-brand&quot;</span><span class="p">))</span>
</span><span class='line'>            <span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'>            <span class="p">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;navbar-collapse collapse&quot;</span><span class="p">&gt;</span>
</span><span class='line'>                <span class="p">&lt;</span><span class="n">ul</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;nav navbar-nav&quot;</span><span class="p">&gt;</span>
</span><span class='line'>                  <span class="p">&lt;</span><span class="n">li</span><span class="p">&gt;</span><span class="err">@</span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">FeatureLink</span><span class="p">&lt;</span><span class="n">Home</span><span class="p">.</span><span class="n">Index</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;(</span><span class="n">aLinkText</span><span class="p">:</span> <span class="s">&quot;Home&quot;</span><span class="p">))&lt;/</span><span class="n">li</span><span class="p">&gt;</span>
</span><span class='line'>                  <span class="p">&lt;</span><span class="n">li</span><span class="p">&gt;</span><span class="err">@</span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">FeatureLink</span><span class="p">&lt;</span><span class="n">Home</span><span class="p">.</span><span class="n">About</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;(</span><span class="n">aLinkText</span><span class="p">:</span> <span class="s">&quot;About&quot;</span><span class="p">))&lt;/</span><span class="n">li</span><span class="p">&gt;</span>
</span><span class='line'>                  <span class="p">&lt;</span><span class="n">li</span><span class="p">&gt;</span><span class="err">@</span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">FeatureLink</span><span class="p">&lt;</span><span class="n">Home</span><span class="p">.</span><span class="n">Contact</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;(</span><span class="n">aLinkText</span><span class="p">:</span> <span class="s">&quot;Contact&quot;</span><span class="p">))&lt;/</span><span class="n">li</span><span class="p">&gt;</span>
</span><span class='line'>                  <span class="p">&lt;</span><span class="n">li</span><span class="p">&gt;</span><span class="err">@</span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">FeatureLink</span><span class="p">&lt;</span><span class="n">User</span><span class="p">.</span><span class="n">Index</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;(</span><span class="n">aLinkText</span><span class="p">:</span> <span class="s">&quot;Users&quot;</span><span class="p">))&lt;/</span><span class="n">li</span><span class="p">&gt;</span>
</span><span class='line'>                <span class="p">&lt;/</span><span class="n">ul</span><span class="p">&gt;</span>
</span><span class='line'>            <span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'>        <span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="p">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;container body-content&quot;</span><span class="p">&gt;</span>
</span><span class='line'>        <span class="n">@RenderBody</span><span class="p">()</span>
</span><span class='line'>        <span class="p">&lt;</span><span class="n">hr</span> <span class="p">/&gt;</span>
</span><span class='line'>        <span class="p">&lt;</span><span class="n">footer</span><span class="p">&gt;</span>
</span><span class='line'>            <span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;&amp;</span><span class="n">copy</span><span class="p">;</span> <span class="n">@DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">Year</span> <span class="p">-</span> <span class="n">My</span> <span class="n">ASP</span><span class="p">.</span><span class="n">NET</span> <span class="n">Application</span><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>        <span class="p">&lt;/</span><span class="n">footer</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Scripts</span><span class="p">.</span><span class="n">Render</span><span class="p">(</span><span class="s">&quot;~/bundles/jquery&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">@Scripts</span><span class="p">.</span><span class="n">Render</span><span class="p">(</span><span class="s">&quot;~/bundles/bootstrap&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">@RenderSection</span><span class="p">(</span><span class="s">&quot;scripts&quot;</span><span class="p">,</span> <span class="n">required</span><span class="p">:</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">body</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">html</span><span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<h3>Index.cshtml</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">@model</span> <span class="n">Index</span><span class="p">.</span><span class="n">Result</span>
</span><span class='line'><span class="n">@using</span> <span class="n">JimmyMvc</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="n">User</span><span class="p">;</span>
</span><span class='line'><span class="n">@using</span> <span class="n">PagedList</span><span class="p">.</span><span class="n">Mvc</span><span class="p">;</span>
</span><span class='line'><span class="p">&lt;</span><span class="n">link</span> <span class="n">href</span><span class="p">=</span><span class="s">&quot;~/Content/PagedList.css&quot;</span> <span class="n">rel</span><span class="p">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="n">type</span><span class="p">=</span><span class="s">&quot;text/css&quot;</span> <span class="p">/&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">@</span><span class="p">{</span>
</span><span class='line'>  <span class="n">ViewBag</span><span class="p">.</span><span class="n">Title</span> <span class="p">=</span> <span class="s">&quot;Users&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">h2</span><span class="p">&gt;</span><span class="n">Users</span><span class="p">&lt;/</span><span class="n">h2</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="err">@</span><span class="p">*</span><span class="err">@</span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">FeatureLink</span><span class="p">&lt;</span><span class="n">Create</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;(</span><span class="n">aLinkText</span><span class="p">:</span> <span class="s">&quot;Create New&quot;</span><span class="p">))*</span><span class="err">@</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">&lt;</span><span class="n">form</span> <span class="n">method</span><span class="p">=</span><span class="s">&quot;GET&quot;</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="n">Find</span> <span class="n">by</span> <span class="n">name</span><span class="p">:</span> <span class="n">@Html</span><span class="p">.</span><span class="n">Input</span><span class="p">(</span><span class="n">aResult</span> <span class="p">=&gt;</span> <span class="n">aResult</span><span class="p">.</span><span class="n">SearchString</span><span class="p">).</span><span class="n">RemoveClass</span><span class="p">(</span><span class="n">className</span><span class="p">:</span> <span class="s">&quot;form-control&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">input</span> <span class="n">type</span><span class="p">=</span><span class="s">&quot;submit&quot;</span> <span class="k">value</span><span class="p">=</span><span class="s">&quot;Search&quot;</span> <span class="p">/&gt;</span>
</span><span class='line'>  <span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">form</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">&lt;</span><span class="n">table</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;table&quot;</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span><span class="n">tr</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">th</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="err">@</span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">FeatureLink</span><span class="p">&lt;</span><span class="n">Index</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;(</span><span class="n">aLinkText</span><span class="p">:</span> <span class="s">&quot;Last Name&quot;</span><span class="p">,</span> <span class="n">aRouteValues</span><span class="p">:</span> <span class="k">new</span> <span class="n">Index</span><span class="p">.</span><span class="n">Query</span> <span class="p">{</span> <span class="n">SortOrder</span> <span class="p">=</span> <span class="n">Model</span><span class="p">.</span><span class="n">NameSortParm</span><span class="p">,</span> <span class="n">CurrentFilter</span> <span class="p">=</span> <span class="n">Model</span><span class="p">.</span><span class="n">CurrentFilter</span> <span class="p">}))</span>
</span><span class='line'>      <span class="p">&lt;/</span><span class="n">th</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">th</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="n">First</span> <span class="n">Name</span>
</span><span class='line'>      <span class="p">&lt;/</span><span class="n">th</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">th</span><span class="p">&gt;&lt;/</span><span class="n">th</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;/</span><span class="n">tr</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="err">@</span><span class="p">{</span> <span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">@foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">Model</span><span class="p">.</span><span class="n">Users</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>  <span class="p">&lt;</span><span class="n">tr</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">td</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="n">@Html</span><span class="p">.</span><span class="n">Display</span><span class="p">(</span><span class="n">aResult</span> <span class="p">=&gt;</span> <span class="n">aResult</span><span class="p">.</span><span class="n">Users</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">LastName</span><span class="p">)</span>
</span><span class='line'>      <span class="p">&lt;/</span><span class="n">td</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">td</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="n">@Html</span><span class="p">.</span><span class="n">Display</span><span class="p">(</span><span class="n">aResult</span> <span class="p">=&gt;</span> <span class="n">aResult</span><span class="p">.</span><span class="n">Users</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">FirstAndMiddleName</span><span class="p">)</span>
</span><span class='line'>      <span class="p">&lt;/</span><span class="n">td</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">td</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="err">@</span><span class="p">*</span><span class="err">@</span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">FeatureLink</span><span class="p">&lt;</span><span class="n">Edit</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;(</span><span class="n">aLinkText</span><span class="p">:</span> <span class="s">&quot;Edit&quot;</span><span class="p">,</span> <span class="n">aRouteValues</span><span class="p">:</span> <span class="k">new</span> <span class="n">Edit</span><span class="p">.</span><span class="n">Query</span> <span class="p">{</span> <span class="n">UserId</span> <span class="p">=</span> <span class="n">item</span><span class="p">.</span><span class="n">UserId</span> <span class="p">}))</span> <span class="p">|*</span><span class="err">@</span>
</span><span class='line'>          <span class="err">@</span><span class="p">*</span><span class="err">@</span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">FeatureLink</span><span class="p">&lt;</span><span class="n">Details</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;(</span><span class="n">aLinkText</span><span class="p">:</span> <span class="s">&quot;Details&quot;</span><span class="p">,</span> <span class="n">aRouteValues</span><span class="p">:</span> <span class="k">new</span> <span class="n">Details</span><span class="p">.</span><span class="n">Query</span> <span class="p">{</span> <span class="n">UserId</span> <span class="p">=</span> <span class="n">item</span><span class="p">.</span><span class="n">UserId</span> <span class="p">}))</span> <span class="p">|*</span><span class="err">@</span>
</span><span class='line'>          <span class="err">@</span><span class="p">*</span><span class="err">@</span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">FeatureLink</span><span class="p">&lt;</span><span class="n">Delete</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;(</span><span class="n">aLinkText</span><span class="p">:</span> <span class="s">&quot;Delete&quot;</span><span class="p">,</span> <span class="n">aRouteValues</span><span class="p">:</span> <span class="k">new</span> <span class="n">Delete</span><span class="p">.</span><span class="n">Query</span> <span class="p">{</span> <span class="n">UserId</span> <span class="p">=</span> <span class="n">item</span><span class="p">.</span><span class="n">UserId</span> <span class="p">}))*</span><span class="err">@</span>
</span><span class='line'>      <span class="p">&lt;/</span><span class="n">td</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;/</span><span class="n">tr</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="n">i</span><span class="p">++;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;/</span><span class="n">table</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">&lt;</span><span class="n">br</span> <span class="p">/&gt;</span>
</span><span class='line'>      <span class="n">Page</span> <span class="err">@</span><span class="p">(</span><span class="n">Model</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="n">PageCount</span> <span class="p">&lt;</span> <span class="n">Model</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="n">PageNumber</span> <span class="p">?</span> <span class="m">0</span> <span class="p">:</span> <span class="n">Model</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="n">PageNumber</span><span class="p">)</span> <span class="n">of</span> <span class="n">@Model</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="n">PageCount</span>
</span><span class='line'>
</span><span class='line'>      <span class="err">@</span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">PagedListPager</span><span class="p">(</span><span class="n">Model</span><span class="p">.</span><span class="n">Users</span><span class="p">,</span> <span class="n">aPage</span> <span class="p">=&gt;</span> <span class="n">Url</span><span class="p">.</span><span class="n">Feature</span><span class="p">&lt;</span><span class="n">Index</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;(</span><span class="n">aRouteValues</span><span class="p">:</span> <span class="k">new</span> <span class="n">Index</span><span class="p">.</span><span class="n">Query</span> <span class="p">{</span> <span class="n">Page</span> <span class="p">=</span> <span class="n">aPage</span><span class="p">,</span> <span class="n">SortOrder</span> <span class="p">=</span> <span class="n">Model</span><span class="p">.</span><span class="n">CurrentSort</span><span class="p">,</span> <span class="n">CurrentFilter</span> <span class="p">=</span> <span class="n">Model</span><span class="p">.</span><span class="n">CurrentFilter</span> <span class="p">})))</span>
</span></code></pre></td></tr></table></div></figure>

<p>We have commented out our future links since the Create,Edit,Details,Delete Features are yet to be completed.</p>

<p>Build and run and now you should be able to see the Users list with paging. All features currently implemented should now be functional.</p>

<h1>Feature User/Details</h1>

<p>Now we have most of the foundation we need to start cranking out some features.  The details feature is the most similar to the Index feature in that we have a Query, QueryHandler, Result, UiController, Mapping and a View. So will go there next, although this time we are going to use an asynchronous process. </p>

<p>Create the <code>Details</code> class in the User Directory</p>

<h2>User.Details</h2>

<p>We have a trivial Query object in that we only need the UserId. The result of the query will be the User information and a list of owned ApprovalListTemplates. </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Features.User</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">AutoMapper</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Entities</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Mehdime.Entity</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">Details</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="k">class</span> <span class="nc">Query</span> <span class="p">:</span> <span class="n">IAsyncRequest</span><span class="p">&lt;</span><span class="n">Result</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">int?</span> <span class="n">UserId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">class</span> <span class="nc">Result</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">int</span> <span class="n">UserId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">         [Display(Name = &quot;First Name&quot;)]</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstAndMiddleName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>          <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ApprovalListTemplate</span><span class="p">&gt;</span> <span class="n">ApprovalListTemplates</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="k">class</span> <span class="nc">ApprovalListTemplate</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>              <span class="k">public</span> <span class="kt">int</span> <span class="n">RecipientCount</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">class</span> <span class="nc">QueryHandler</span> <span class="p">:</span> <span class="n">IAsyncRequestHandler</span><span class="p">&lt;</span><span class="n">Query</span><span class="p">,</span> <span class="n">Result</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">private</span> <span class="n">IDbContextScopeFactory</span> <span class="n">DbContextScopeFactory</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="nf">QueryHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">DbContextScopeFactory</span> <span class="p">=</span> <span class="n">aDbContextScopeFactory</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Result</span><span class="p">&gt;</span> <span class="n">Handle</span><span class="p">(</span><span class="n">Query</span> <span class="n">aQuery</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">dbContextScope</span> <span class="p">=</span> <span class="n">DbContextScopeFactory</span><span class="p">.</span><span class="n">CreateReadOnly</span><span class="p">())</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">Model</span> <span class="n">model</span> <span class="p">=</span> <span class="n">dbContextScope</span><span class="p">.</span><span class="n">DbContexts</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">Model</span><span class="p">&gt;();</span>
</span><span class='line'>                  <span class="n">Result</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">model</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">aUser</span> <span class="p">=&gt;</span> <span class="n">aUser</span><span class="p">.</span><span class="n">UserId</span> <span class="p">==</span> <span class="n">aQuery</span><span class="p">.</span><span class="n">UserId</span><span class="p">).</span><span class="n">ProjectToSingleOrDefaultAsync</span><span class="p">&lt;</span><span class="n">Result</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>                  <span class="n">result</span><span class="p">.</span><span class="n">ApprovalListTemplates</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Result</span><span class="p">.</span><span class="n">ApprovalListTemplate</span><span class="p">&gt;();</span>
</span><span class='line'>                  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">class</span> <span class="nc">UiController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMediator</span> <span class="n">mediator</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="nf">UiController</span><span class="p">(</span><span class="n">IMediator</span> <span class="n">aMediator</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">mediator</span> <span class="p">=</span> <span class="n">aMediator</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="k">virtual</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&gt;</span> <span class="n">Action</span><span class="p">(</span><span class="n">Query</span> <span class="n">aQuery</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">Result</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">mediator</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">aQuery</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">class</span> <span class="nc">MappingProfile</span> <span class="p">:</span> <span class="n">Profile</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">()</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">CreateMap</span><span class="p">&lt;</span><span class="n">User</span><span class="p">,</span> <span class="n">Result</span><span class="p">&gt;();</span>
</span><span class='line'>              <span class="c1">//CreateMap&lt;ApprovalListTemplate, Result.ApprovalListTemplate&gt;();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Index.cshtml</h2>

<p>Update the <code>Index.cshtml</code> page to now link to the Details page by uncommenting the FeatureLink.</p>

<p><code>@(Html.FeatureLink&lt;Details.UiController&gt;(aLinkText: &quot;Details&quot;, aRouteValues: new Details.Query { UserId = item.UserId })) |</code></p>

<h2>Deatails.cshtml</h2>

<p>Create the Details.cshtml View</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">@using</span> <span class="n">JimmyMvc</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="n">User</span>
</span><span class='line'><span class="n">@model</span> <span class="n">Details</span><span class="p">.</span><span class="n">Result</span>
</span><span class='line'>
</span><span class='line'><span class="err">@</span><span class="p">{</span>
</span><span class='line'>  <span class="n">ViewBag</span><span class="p">.</span><span class="n">Title</span> <span class="p">=</span> <span class="s">&quot;Details&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">h2</span><span class="p">&gt;</span><span class="n">Details</span><span class="p">&lt;/</span><span class="n">h2</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span><span class="n">h4</span><span class="p">&gt;</span><span class="n">User</span><span class="p">&lt;/</span><span class="n">h4</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span><span class="n">hr</span> <span class="p">/&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span><span class="n">dl</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;dl-horizontal&quot;</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">dt</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="n">@Html</span><span class="p">.</span><span class="n">DisplayLabel</span><span class="p">(</span><span class="n">aModel</span> <span class="p">=&gt;</span> <span class="n">aModel</span><span class="p">.</span><span class="n">LastName</span><span class="p">)</span>
</span><span class='line'>      <span class="p">&lt;/</span><span class="n">dt</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">dd</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="n">@Html</span><span class="p">.</span><span class="n">Display</span><span class="p">(</span><span class="n">aModel</span> <span class="p">=&gt;</span> <span class="n">aModel</span><span class="p">.</span><span class="n">LastName</span><span class="p">)</span>
</span><span class='line'>      <span class="p">&lt;/</span><span class="n">dd</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">dt</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="n">@Html</span><span class="p">.</span><span class="n">DisplayLabel</span><span class="p">(</span><span class="n">aModel</span> <span class="p">=&gt;</span> <span class="n">aModel</span><span class="p">.</span><span class="n">FirstAndMiddleName</span><span class="p">)</span>
</span><span class='line'>      <span class="p">&lt;/</span><span class="n">dt</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">dd</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="n">@Html</span><span class="p">.</span><span class="n">Display</span><span class="p">(</span><span class="n">aModel</span> <span class="p">=&gt;</span> <span class="n">aModel</span><span class="p">.</span><span class="n">FirstAndMiddleName</span><span class="p">)</span>
</span><span class='line'>      <span class="p">&lt;/</span><span class="n">dd</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">dt</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="n">@Html</span><span class="p">.</span><span class="n">DisplayLabel</span><span class="p">(</span><span class="n">aModel</span> <span class="p">=&gt;</span> <span class="n">aModel</span><span class="p">.</span><span class="n">ApprovalListTemplates</span><span class="p">)</span>
</span><span class='line'>      <span class="p">&lt;/</span><span class="n">dt</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">dd</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="p">&lt;</span><span class="n">table</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;table&quot;</span><span class="p">&gt;</span>
</span><span class='line'>              <span class="p">&lt;</span><span class="n">tr</span><span class="p">&gt;</span>
</span><span class='line'>                  <span class="p">&lt;</span><span class="n">th</span><span class="p">&gt;</span><span class="n">Name</span><span class="p">&lt;/</span><span class="n">th</span><span class="p">&gt;</span>
</span><span class='line'>                  <span class="p">&lt;</span><span class="n">th</span><span class="p">&gt;</span><span class="n">Recipient</span> <span class="n">Count</span><span class="p">&lt;/</span><span class="n">th</span><span class="p">&gt;</span>
</span><span class='line'>              <span class="p">&lt;/</span><span class="n">tr</span><span class="p">&gt;</span>
</span><span class='line'>              <span class="n">@for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">Model</span><span class="p">.</span><span class="n">ApprovalListTemplates</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>              <span class="p">&lt;</span><span class="n">tr</span><span class="p">&gt;</span>
</span><span class='line'>                  <span class="p">&lt;</span><span class="n">td</span><span class="p">&gt;</span>
</span><span class='line'>                      <span class="n">@Html</span><span class="p">.</span><span class="n">Display</span><span class="p">(</span><span class="n">aResult</span> <span class="p">=&gt;</span> <span class="n">aResult</span><span class="p">.</span><span class="n">ApprovalListTemplates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Name</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">&lt;/</span><span class="n">td</span><span class="p">&gt;</span>
</span><span class='line'>                  <span class="p">&lt;</span><span class="n">td</span><span class="p">&gt;</span>
</span><span class='line'>                      <span class="n">@Html</span><span class="p">.</span><span class="n">Display</span><span class="p">(</span><span class="n">aResult</span> <span class="p">=&gt;</span> <span class="n">aResult</span><span class="p">.</span><span class="n">ApprovalListTemplates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RecipientCount</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">&lt;/</span><span class="n">td</span><span class="p">&gt;</span>
</span><span class='line'>              <span class="p">&lt;/</span><span class="n">tr</span><span class="p">&gt;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">&lt;/</span><span class="n">table</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;/</span><span class="n">dd</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;/</span><span class="n">dl</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="err">@</span><span class="p">*</span><span class="err">@</span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">FeatureLink</span><span class="p">&lt;</span><span class="n">Edit</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;(</span><span class="n">aLinkText</span><span class="p">:</span> <span class="s">&quot;Edit&quot;</span><span class="p">,</span> <span class="n">aRouteValues</span><span class="p">:</span> <span class="k">new</span> <span class="n">Edit</span><span class="p">.</span><span class="n">Query</span> <span class="p">{</span> <span class="n">UserId</span> <span class="p">=</span> <span class="n">Model</span><span class="p">.</span><span class="n">UserId</span> <span class="p">}))</span> <span class="p">|*</span><span class="err">@</span>
</span><span class='line'>  <span class="err">@</span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">FeatureLink</span><span class="p">&lt;</span><span class="n">Index</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;(</span><span class="n">aLinkText</span><span class="p">:</span> <span class="s">&quot;Back to List&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>Excute and run.</p>

<p>Notice we commented out the Edit link above as we have yet to implment that feature. I would like to do that now. But first we must introduce Validation.</p>

<h3>Validation</h3>

<p>Typically Validation is done on each controller doing something like</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[HttpPost]</span>
</span><span class='line'><span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Edit</span><span class="p">(</span><span class="n">Model</span> <span class="n">form</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(!</span><span class="n">ModelState</span><span class="p">.</span><span class="n">IsValid</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">form</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>The solution we are going to implement is documented <a href="http://timgthomas.com/2013/09/simplify-client-side-validation-by-adding-a-server/">here</a></p>

<p>Create a <code>Validation</code> folder under the <code>Infrastructure</code> Folder.</p>

<h2>ValidationActionFilter</h2>

<p>Using an existing MVC Extension point create an ActionFilter that intercepts the action if the ModelState is NOT valid it will return a json serialized version of the ModelState.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.Validation</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Net</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Newtonsoft.Json</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">ValidatorActionFilter</span> <span class="p">:</span> <span class="n">IActionFilter</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="k">void</span> <span class="nf">OnActionExecuting</span><span class="p">(</span><span class="n">ActionExecutingContext</span> <span class="n">aFilterContext</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(!</span><span class="n">aFilterContext</span><span class="p">.</span><span class="n">Controller</span><span class="p">.</span><span class="n">ViewData</span><span class="p">.</span><span class="n">ModelState</span><span class="p">.</span><span class="n">IsValid</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">aFilterContext</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">HttpMethod</span> <span class="p">==</span> <span class="s">&quot;GET&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HttpStatusCodeResult</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">BadRequest</span><span class="p">);</span>
</span><span class='line'>                  <span class="n">aFilterContext</span><span class="p">.</span><span class="n">Result</span> <span class="p">=</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="k">else</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ContentResult</span><span class="p">();</span>
</span><span class='line'>                  <span class="kt">string</span> <span class="n">content</span> <span class="p">=</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="n">SerializeObject</span><span class="p">(</span><span class="n">aFilterContext</span><span class="p">.</span><span class="n">Controller</span><span class="p">.</span><span class="n">ViewData</span><span class="p">.</span><span class="n">ModelState</span><span class="p">,</span>
</span><span class='line'>                          <span class="k">new</span> <span class="n">JsonSerializerSettings</span>
</span><span class='line'>                          <span class="p">{</span>
</span><span class='line'>                              <span class="n">ReferenceLoopHandling</span> <span class="p">=</span> <span class="n">ReferenceLoopHandling</span><span class="p">.</span><span class="n">Ignore</span>
</span><span class='line'>                          <span class="p">});</span>
</span><span class='line'>                  <span class="n">result</span><span class="p">.</span><span class="n">Content</span> <span class="p">=</span> <span class="n">content</span><span class="p">;</span>
</span><span class='line'>                  <span class="n">result</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="s">&quot;application/json&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                  <span class="n">aFilterContext</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">=</span> <span class="m">400</span><span class="p">;</span>
</span><span class='line'>                  <span class="n">aFilterContext</span><span class="p">.</span><span class="n">Result</span> <span class="p">=</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">void</span> <span class="nf">OnActionExecuted</span><span class="p">(</span><span class="n">ActionExecutedContext</span> <span class="n">aFilterContext</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>FilterConfig.cs</h2>

<p>Add the filter by updating the <code>App_Start\FilterConfig.cs</code> file to be as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">JimmyMvc.Infrastructure.Validation</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">FilterConfig</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">RegisterGlobalFilters</span><span class="p">(</span><span class="n">GlobalFilterCollection</span> <span class="n">aGlobalFilterCollection</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">aGlobalFilterCollection</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">HandleErrorAttribute</span><span class="p">());</span>
</span><span class='line'>          <span class="n">aGlobalFilterCollection</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">ValidatorActionFilter</span><span class="p">());</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>StructureMapValidatorFactory</h2>

<p>Create the <code>StructureMapValidatorFactory</code> class in the <code>Infrastructure\Validation</code> folder as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.Validation</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">App_Start</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">FluentValidation</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">StructureMapValidatorFactory</span> <span class="p">:</span> <span class="n">ValidatorFactoryBase</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="k">override</span> <span class="n">IValidator</span> <span class="nf">CreateInstance</span><span class="p">(</span><span class="n">Type</span> <span class="n">aValidatorType</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">StructuremapMvc</span><span class="p">.</span><span class="n">StructureMapDependencyScope</span><span class="p">.</span><span class="n">CurrentNestedContainer</span><span class="p">.</span><span class="n">TryGetInstance</span><span class="p">(</span><span class="n">aValidatorType</span><span class="p">)</span> <span class="k">as</span> <span class="n">IValidator</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>AjaxValidation.js</h2>

<p>Create the AjaxValidation.js file in the Scripts folder as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
</pre></td><td class='code'><pre><code class='JavaScript'><span class='line'><span class="kd">var</span> <span class="nx">highlightFields</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.form-group&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;has-error&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">propName</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">nameSelector</span> <span class="o">=</span> <span class="s1">&#39;[name = &quot;&#39;</span> <span class="o">+</span> <span class="nx">propName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(:|\.|\[|\])/g</span><span class="p">,</span> <span class="s2">&quot;\\$1&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;]&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="nx">idSelector</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">propName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(:|\.|\[|\])/g</span><span class="p">,</span> <span class="s2">&quot;\\$1&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">$el</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">nameSelector</span><span class="p">)</span> <span class="o">||</span> <span class="nx">$</span><span class="p">(</span><span class="nx">idSelector</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">val</span><span class="p">.</span><span class="nx">Errors</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">$el</span><span class="p">.</span><span class="nx">closest</span><span class="p">(</span><span class="s1">&#39;.form-group&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;has-error&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">highlightErrors</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">highlightFields</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">showSummary</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>      <span class="nb">window</span><span class="p">.</span><span class="nx">scrollTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// (Hopefully) caught by the generic error handler in `config.js`.</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">showSummary</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#validationSummary&#39;</span><span class="p">).</span><span class="nx">empty</span><span class="p">().</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">verboseErrors</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="s1">&#39;Errors&#39;</span><span class="p">)),</span>
</span><span class='line'>      <span class="nx">errors</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">nonNullErrors</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">verboseErrors</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">error</span><span class="p">.</span><span class="nx">ErrorMessage</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;must not be empty&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">nonNullErrors</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">ErrorMessage</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">nonNullErrors</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="nx">verboseErrors</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;The highlighted fields are required to submit this form.&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">$ul</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#validationSummary&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;ul&gt;&lt;/ul&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">errors</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">$li</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&lt;/li&gt;&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">$li</span><span class="p">.</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">$ul</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">redirect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">redirect</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">redirect</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">window</span><span class="p">.</span><span class="nx">scrollTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>      <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;form[method=post]&#39;</span><span class="p">).</span><span class="nx">not</span><span class="p">(</span><span class="s1">&#39;.no-ajax&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">submitBtn</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;[type=&quot;submit&quot;]&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">submitBtn</span><span class="p">.</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">unbind</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">$this</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">),</span>
</span><span class='line'>      <span class="nx">formData</span> <span class="o">=</span> <span class="nx">$this</span><span class="p">.</span><span class="nx">serialize</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$this</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;has-error&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">url</span><span class="o">:</span> <span class="nx">$this</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">),</span>
</span><span class='line'>      <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">data</span><span class="o">:</span> <span class="nx">formData</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">contentType</span><span class="o">:</span> <span class="s1">&#39;application/x-www-form-urlencoded; charset=UTF-8&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">statusCode</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="mi">200</span><span class="o">:</span> <span class="nx">redirect</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nx">complete</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">submitBtn</span><span class="p">.</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}).</span><span class="nx">error</span><span class="p">(</span><span class="nx">highlightErrors</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Update BundleConfig.cs</h2>

<p>Add to the bundle.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>           <span class="n">bundles</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">ScriptBundle</span><span class="p">(</span><span class="s">&quot;~/bundles/lodash&quot;</span><span class="p">).</span><span class="n">Include</span><span class="p">(</span>
</span><span class='line'>                                          <span class="s">&quot;~/Scripts/lodash.js&quot;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">bundles</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">ScriptBundle</span><span class="p">(</span><span class="s">&quot;~/bundles/AjaxValidation&quot;</span><span class="p">).</span><span class="n">Include</span><span class="p">(</span>
</span><span class='line'>                                          <span class="s">&quot;~/Scripts/AjaxValidation.js&quot;</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>

<h2>_Layout.cshtml</h2>

<p>In the head just below <code>@Scripts.Render(&quot;~/bundles/modernizr&quot;)</code> add the following:
<code>@Scripts.Render(&quot;~/bundles/lodash&quot;)</code></p>

<p>Add the javascript just before the closing body tag, to intercept the form post and convert it to an ajax json call for validation as follows:</p>

<p><code>@Scripts.Render(&quot;~/bundles/AjaxValidation&quot;)</code></p>

<h2>DefaultRegistry</h2>

<p>Update the IoC <code>DefaultRegistry.cs</code> file to use the StructureMapValidatorFactory</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.DependencyResolution</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Entities</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">FluentValidation</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Infrastructure</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">StructureMap.Configuration.DSL</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">StructureMap.Graph</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">StructureMap.Pipeline</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Infrastructure.Validation</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Mehdime.Entity</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">DefaultRegistry</span> <span class="p">:</span> <span class="n">Registry</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="cp">#region Constructors and Destructors</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="nf">DefaultRegistry</span><span class="p">()</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">Scan</span><span class="p">(</span>
</span><span class='line'>                          <span class="n">aAssemblyScanner</span> <span class="p">=&gt;</span>
</span><span class='line'>                          <span class="p">{</span>
</span><span class='line'>                              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">TheCallingAssembly</span><span class="p">();</span>
</span><span class='line'>                              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">WithDefaultConventions</span><span class="p">();</span>
</span><span class='line'>                              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">LookForRegistries</span><span class="p">();</span>
</span><span class='line'>                              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">AssemblyContainingType</span><span class="p">&lt;</span><span class="n">DefaultRegistry</span><span class="p">&gt;();</span>
</span><span class='line'>                              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">AddAllTypesOf</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IModelBinder</span><span class="p">));</span>
</span><span class='line'>                              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">AddAllTypesOf</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IModelBinderProvider</span><span class="p">));</span>
</span><span class='line'>                              <span class="n">aAssemblyScanner</span><span class="p">.</span><span class="n">With</span><span class="p">(</span><span class="k">new</span> <span class="n">ControllerConvention</span><span class="p">());</span>
</span><span class='line'>                          <span class="p">});</span>
</span><span class='line'>          <span class="n">For</span><span class="p">&lt;</span><span class="n">ModelValidatorProvider</span><span class="p">&gt;().</span><span class="n">Use</span><span class="p">&lt;</span><span class="n">FluentValidationModelValidatorProvider</span><span class="p">&gt;();</span>
</span><span class='line'>          <span class="n">For</span><span class="p">&lt;</span><span class="n">IControllerFactory</span><span class="p">&gt;().</span><span class="n">Use</span><span class="p">&lt;</span><span class="n">ControllerFactory</span><span class="p">&gt;();</span>
</span><span class='line'>          <span class="n">For</span><span class="p">&lt;</span><span class="n">IDbContextFactory</span><span class="p">&gt;().</span><span class="n">Use</span><span class="p">&lt;</span><span class="n">DbContextFactory</span><span class="p">&gt;().</span><span class="n">LifecycleIs</span><span class="p">&lt;</span><span class="n">ContainerLifecycle</span><span class="p">&gt;();</span>
</span><span class='line'>          <span class="n">For</span><span class="p">&lt;</span><span class="n">IDbContextScopeFactory</span><span class="p">&gt;().</span><span class="n">Use</span><span class="p">&lt;</span><span class="n">DbContextScopeFactory</span><span class="p">&gt;().</span><span class="n">LifecycleIs</span><span class="p">&lt;</span><span class="n">ContainerLifecycle</span><span class="p">&gt;();</span>
</span><span class='line'>          <span class="n">For</span><span class="p">&lt;</span><span class="n">IAmbientDbContextLocator</span><span class="p">&gt;().</span><span class="n">Use</span><span class="p">&lt;</span><span class="n">AmbientDbContextLocator</span><span class="p">&gt;().</span><span class="n">LifecycleIs</span><span class="p">&lt;</span><span class="n">ContainerLifecycle</span><span class="p">&gt;();</span>
</span><span class='line'>          <span class="n">For</span><span class="p">&lt;</span><span class="n">IValidatorFactory</span><span class="p">&gt;().</span><span class="n">Use</span><span class="p">&lt;</span><span class="n">StructureMapValidatorFactory</span><span class="p">&gt;();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="cp">#endregion</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>ControllerExtensions</h2>

<p>Create class <code>ControllerExtensions</code> in the <code>Infrastructure/Extensions</code> Folder as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.Extensions</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Linq.Expressions</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Newtonsoft.Json</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ControllerExtensions</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">ActionResult</span> <span class="n">RedirectToFeatureJson</span><span class="p">&lt;</span><span class="n">TController</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">Controller</span> <span class="n">aController</span><span class="p">,</span> <span class="n">Object</span> <span class="n">aRouteValues</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>          <span class="k">where</span> <span class="n">TController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">aController</span><span class="p">.</span><span class="n">JsonNet</span><span class="p">(</span><span class="k">new</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">redirect</span> <span class="p">=</span> <span class="n">aController</span><span class="p">.</span><span class="n">Url</span><span class="p">.</span><span class="n">Feature</span><span class="p">&lt;</span><span class="n">TController</span><span class="p">&gt;(</span><span class="n">aRouteValues</span><span class="p">)</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">static</span> <span class="n">ContentResult</span> <span class="nf">JsonNet</span><span class="p">(</span><span class="k">this</span> <span class="n">Controller</span> <span class="n">aController</span><span class="p">,</span> <span class="kt">object</span> <span class="n">aModel</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">serialized</span> <span class="p">=</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="n">SerializeObject</span><span class="p">(</span><span class="n">aModel</span><span class="p">,</span> <span class="k">new</span> <span class="n">JsonSerializerSettings</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">ReferenceLoopHandling</span> <span class="p">=</span> <span class="n">ReferenceLoopHandling</span><span class="p">.</span><span class="n">Ignore</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">return</span> <span class="k">new</span> <span class="n">ContentResult</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">Content</span> <span class="p">=</span> <span class="n">serialized</span><span class="p">,</span>
</span><span class='line'>              <span class="n">ContentType</span> <span class="p">=</span> <span class="s">&quot;application/json&quot;</span>
</span><span class='line'>          <span class="p">};</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>This completes the Validation infrastrucuture.</p>

<h1>Feature User/Edit</h1>

<p>Create <code>Edit</code> class under the User Folder. </p>

<h2>User.Edit.Query</h2>

<p>Add the following nested Query class.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">Query</span> <span class="p">:</span> <span class="n">IAsyncRequest</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">int?</span> <span class="n">UserId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Edit.QueryValidator</h2>

<p>We will add validation for this query using the FluentValidation.  Add a nested QueryValidation class as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">QueryValidator</span> <span class="p">:</span> <span class="n">AbstractValidator</span><span class="p">&lt;</span><span class="n">Query</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="nf">QueryValidator</span><span class="p">()</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">RuleFor</span><span class="p">(</span><span class="n">aQuery</span> <span class="p">=&gt;</span> <span class="n">aQuery</span><span class="p">.</span><span class="n">UserId</span><span class="p">).</span><span class="n">NotNull</span><span class="p">();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Edit.QueryHandler</h2>

<p>The query handler is rather simple linq query projected via automapper onto the Command/Result.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>   <span class="k">public</span> <span class="k">class</span> <span class="nc">QueryHandler</span> <span class="p">:</span> <span class="n">IAsyncRequestHandler</span><span class="p">&lt;</span><span class="n">Query</span><span class="p">,</span> <span class="n">Command</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">private</span> <span class="n">IDbContextScopeFactory</span> <span class="n">DbContextScopeFactory</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="nf">QueryHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">DbContextScopeFactory</span> <span class="p">=</span> <span class="n">aDbContextScopeFactory</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">&gt;</span> <span class="n">Handle</span><span class="p">(</span><span class="n">Query</span> <span class="n">aQuery</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">dbContextScope</span> <span class="p">=</span> <span class="n">DbContextScopeFactory</span><span class="p">.</span><span class="n">CreateReadOnly</span><span class="p">())</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">Model</span> <span class="n">model</span> <span class="p">=</span> <span class="n">dbContextScope</span><span class="p">.</span><span class="n">DbContexts</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">Model</span><span class="p">&gt;();</span>
</span><span class='line'>                  <span class="k">return</span> <span class="k">await</span> <span class="n">model</span><span class="p">.</span><span class="n">Users</span>
</span><span class='line'>                      <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">aUser</span> <span class="p">=&gt;</span> <span class="n">aUser</span><span class="p">.</span><span class="n">UserId</span> <span class="p">==</span> <span class="n">aQuery</span><span class="p">.</span><span class="n">UserId</span><span class="p">)</span>
</span><span class='line'>                      <span class="p">.</span><span class="n">ProjectToSingleOrDefaultAsync</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">&gt;();</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Edit.Command</h2>

<p>So the Command object is the result of the Query and would be the model usd in the view. A modified version will be posted back.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">Command</span> <span class="p">:</span> <span class="n">IAsyncRequest</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">int</span> <span class="n">UserId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">         [Display(Name = &quot;First Name&quot;)]</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstAndMiddleName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Edit.CommandHandler</h2>

<p>The command handler is the post and execution of the command.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">CommandHandler</span> <span class="p">:</span> <span class="n">AsyncRequestHandler</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">private</span> <span class="n">IDbContextScopeFactory</span> <span class="n">DbContextScopeFactory</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="nf">CommandHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">DbContextScopeFactory</span> <span class="p">=</span> <span class="n">aDbContextScopeFactory</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">protected</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">HandleCore</span><span class="p">(</span><span class="n">Command</span> <span class="n">aCommand</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">dbContextScope</span> <span class="p">=</span> <span class="n">DbContextScopeFactory</span><span class="p">.</span><span class="n">Create</span><span class="p">())</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">Model</span> <span class="n">model</span> <span class="p">=</span> <span class="n">dbContextScope</span><span class="p">.</span><span class="n">DbContexts</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">Model</span><span class="p">&gt;();</span>
</span><span class='line'>                  <span class="n">User</span> <span class="n">user</span> <span class="p">=</span> <span class="k">await</span> <span class="n">model</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="n">FindAsync</span><span class="p">(</span><span class="n">aCommand</span><span class="p">.</span><span class="n">UserId</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                  <span class="n">Mapper</span><span class="p">.</span><span class="n">Map</span><span class="p">(</span><span class="n">aCommand</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span>
</span><span class='line'>                  <span class="k">await</span> <span class="n">dbContextScope</span><span class="p">.</span><span class="n">SaveChangesAsync</span><span class="p">();</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Edit.UiController</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">UiController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMediator</span> <span class="n">mediator</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="nf">UiController</span><span class="p">(</span><span class="n">IMediator</span> <span class="n">aMediator</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">mediator</span> <span class="p">=</span> <span class="n">aMediator</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="k">virtual</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&gt;</span> <span class="n">Action</span><span class="p">(</span><span class="n">Query</span> <span class="n">aQuery</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">Command</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">mediator</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">aQuery</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">         [HttpPost]</span>
</span><span class='line'><span class="na">         [ValidateAntiForgeryToken]</span>
</span><span class='line'>          <span class="k">public</span> <span class="k">virtual</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&gt;</span> <span class="n">Action</span><span class="p">(</span><span class="n">Command</span> <span class="n">aCommand</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">await</span> <span class="n">mediator</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">aCommand</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">RedirectToFeatureJson</span><span class="p">&lt;</span><span class="n">Index</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>MappingProfile</h2>

<p>Create the Map between a User and the Command  and also the reverse.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">MappingProfile</span> <span class="p">:</span> <span class="n">Profile</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">()</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">CreateMap</span><span class="p">&lt;</span><span class="n">User</span><span class="p">,</span> <span class="n">Command</span><span class="p">&gt;().</span><span class="n">ReverseMap</span><span class="p">();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User/Edit.cshtml</h2>

<p>Create Edit.cshtml as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">@using</span> <span class="n">JimmyMvc</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="n">User</span>
</span><span class='line'><span class="n">@model</span> <span class="n">Edit</span><span class="p">.</span><span class="n">Command</span>
</span><span class='line'>
</span><span class='line'><span class="err">@</span><span class="p">{</span>
</span><span class='line'>  <span class="n">ViewBag</span><span class="p">.</span><span class="n">Title</span> <span class="p">=</span> <span class="s">&quot;Edit&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">h2</span><span class="p">&gt;</span><span class="n">Edit</span><span class="p">&lt;/</span><span class="n">h2</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">@using</span> <span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">BeginForm</span><span class="p">())</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="n">@Html</span><span class="p">.</span><span class="n">AntiForgeryToken</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;form-horizontal&quot;</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span><span class="n">h4</span><span class="p">&gt;</span><span class="n">User</span><span class="p">&lt;/</span><span class="n">h4</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span><span class="n">hr</span> <span class="p">/&gt;</span>
</span><span class='line'>  <span class="n">@Html</span><span class="p">.</span><span class="n">ValidationDiv</span><span class="p">()</span>
</span><span class='line'>  <span class="n">@Html</span><span class="p">.</span><span class="n">Input</span><span class="p">(</span><span class="n">aCommand</span> <span class="p">=&gt;</span> <span class="n">aCommand</span><span class="p">.</span><span class="n">UserId</span><span class="p">)</span>
</span><span class='line'>  <span class="n">@Html</span><span class="p">.</span><span class="n">FormBlock</span><span class="p">(</span><span class="n">aCommand</span> <span class="p">=&gt;</span> <span class="n">aCommand</span><span class="p">.</span><span class="n">LastName</span><span class="p">)</span>
</span><span class='line'>  <span class="n">@Html</span><span class="p">.</span><span class="n">FormBlock</span><span class="p">(</span><span class="n">aCommand</span> <span class="p">=&gt;</span> <span class="n">aCommand</span><span class="p">.</span><span class="n">FirstAndMiddleName</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;col-md-offset-2 col-md-10&quot;</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="p">&lt;</span><span class="n">input</span> <span class="n">type</span><span class="p">=</span><span class="s">&quot;submit&quot;</span> <span class="k">value</span><span class="p">=</span><span class="s">&quot;Save&quot;</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;btn btn-default&quot;</span> <span class="p">/&gt;</span>
</span><span class='line'>      <span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="err">@</span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">FeatureLink</span><span class="p">&lt;</span><span class="n">Index</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;(</span><span class="n">aLinkText</span><span class="p">:</span> <span class="s">&quot;Back to List&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="n">@section</span> <span class="n">Scripts</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">@Scripts</span><span class="p">.</span><span class="n">Render</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="s">&quot;~/bundles/jqueryval&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Index.cshtml</h2>

<p>Update the <code>Index.cshtml</code> page to now link to the Edit page</p>

<p>Uncomment the Edit Link as:</p>

<p><code>@(Html.FeatureLink&lt;Edit.UiController&gt;(aLinkText: &quot;Edit&quot;, aRouteValues: new Edit.Query { UserId = item.UserId })) |</code></p>

<h2>User/Details.cshtml</h2>

<p>Uncomment the Edit Link on the <code>Details.cshtml</code></p>

<p><code>@(Html.FeatureLink&lt;Edit.UiController&gt;(aLinkText: &quot;Edit&quot;, aRouteValues: new Edit.Query { UserId = Model.UserId })) |</code></p>

<p>Build run and test.</p>

<h1>Feature User/Create</h1>

<p>We are going to implement this synchronously.
Create the <code>Create.cs</code> class in the <code>User</code> folder. </p>

<h2>User.Create.Query</h2>

<p>Create the nested Query class in the Create class as follows:
This really is an empty class which means simply that their is no information needed but the request will return a Command.  </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">Query</span><span class="p">:</span> <span class="n">IRequest</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">&gt;{}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Create.QueryHandler</h2>

<p>This just creates a new command object and returns it. </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">QueryHandler</span> <span class="p">:</span> <span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">Query</span><span class="p">,</span> <span class="n">Command</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="n">Command</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">Query</span> <span class="n">aQuery</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">return</span> <span class="k">new</span> <span class="nf">Command</span><span class="p">();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Create.Command</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">Command</span> <span class="p">:</span> <span class="n">IRequest</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">         [Display(Name = &quot;First Name&quot;)]</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstAndMiddleName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Create.CommandValidator</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">CommandValidator</span> <span class="p">:</span> <span class="n">AbstractValidator</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="nf">CommandValidator</span><span class="p">()</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">RuleFor</span><span class="p">(</span><span class="n">aCommand</span> <span class="p">=&gt;</span> <span class="n">aCommand</span><span class="p">.</span><span class="n">LastName</span><span class="p">).</span><span class="n">NotNull</span><span class="p">().</span><span class="n">Length</span><span class="p">(</span><span class="n">min</span><span class="p">:</span> <span class="m">1</span><span class="p">,</span> <span class="n">max</span><span class="p">:</span> <span class="m">50</span><span class="p">);</span>
</span><span class='line'>              <span class="n">RuleFor</span><span class="p">(</span><span class="n">aCommand</span> <span class="p">=&gt;</span> <span class="n">aCommand</span><span class="p">.</span><span class="n">FirstAndMiddleName</span><span class="p">).</span><span class="n">NotNull</span><span class="p">().</span><span class="n">Length</span><span class="p">(</span><span class="n">min</span><span class="p">:</span> <span class="m">1</span><span class="p">,</span> <span class="n">max</span><span class="p">:</span> <span class="m">50</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Create.CommandHandler</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>   <span class="k">public</span> <span class="k">class</span> <span class="nc">CommandHandler</span> <span class="p">:</span> <span class="n">RequestHandler</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">private</span> <span class="n">IDbContextScopeFactory</span> <span class="n">DbContextScopeFactory</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="nf">CommandHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">DbContextScopeFactory</span> <span class="p">=</span> <span class="n">aDbContextScopeFactory</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">HandleCore</span><span class="p">(</span><span class="n">Command</span> <span class="n">aCommand</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">User</span> <span class="n">user</span> <span class="p">=</span> <span class="n">Mapper</span><span class="p">.</span><span class="n">Map</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">,</span> <span class="n">User</span><span class="p">&gt;(</span><span class="n">aCommand</span><span class="p">);</span>
</span><span class='line'>          <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">dbContextScope</span> <span class="p">=</span> <span class="n">DbContextScopeFactory</span><span class="p">.</span><span class="n">Create</span><span class="p">())</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">Model</span> <span class="n">model</span> <span class="p">=</span> <span class="n">dbContextScope</span><span class="p">.</span><span class="n">DbContexts</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">Model</span><span class="p">&gt;();</span>
</span><span class='line'>              <span class="n">model</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</span><span class='line'>              <span class="n">dbContextScope</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Create.UiController</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">UiController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMediator</span> <span class="n">mediator</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="nf">UiController</span><span class="p">(</span><span class="n">IMediator</span> <span class="n">aMediator</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">mediator</span> <span class="p">=</span> <span class="n">aMediator</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="k">virtual</span> <span class="n">ActionResult</span> <span class="nf">Action</span><span class="p">(</span><span class="n">Query</span> <span class="n">aQuery</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">Command</span> <span class="n">command</span> <span class="p">=</span> <span class="n">mediator</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">aQuery</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">         [HttpPost]</span>
</span><span class='line'><span class="na">         [ValidateAntiForgeryToken]</span>
</span><span class='line'>          <span class="k">public</span> <span class="k">virtual</span> <span class="n">ActionResult</span> <span class="nf">Action</span><span class="p">(</span><span class="n">Command</span> <span class="n">aCommand</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">mediator</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">aCommand</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">RedirectToFeatureJson</span><span class="p">&lt;</span><span class="n">Index</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Create.MappingProfile</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">MappingProfile</span> <span class="p">:</span> <span class="n">Profile</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">()</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">CreateMap</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">,</span> <span class="n">User</span><span class="p">&gt;();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User\Create.cshtml</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">@using</span> <span class="n">JimmyMvc</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="n">User</span>
</span><span class='line'><span class="n">@model</span> <span class="n">Create</span><span class="p">.</span><span class="n">Command</span>
</span><span class='line'>
</span><span class='line'><span class="err">@</span><span class="p">{</span>
</span><span class='line'>  <span class="n">ViewBag</span><span class="p">.</span><span class="n">Title</span> <span class="p">=</span> <span class="s">&quot;Create&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">h2</span><span class="p">&gt;</span><span class="n">Create</span><span class="p">&lt;/</span><span class="n">h2</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">@using</span> <span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">BeginForm</span><span class="p">())</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="n">@Html</span><span class="p">.</span><span class="n">AntiForgeryToken</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;form-horizontal&quot;</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span><span class="n">h4</span><span class="p">&gt;</span><span class="n">User</span><span class="p">&lt;/</span><span class="n">h4</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span><span class="n">hr</span> <span class="p">/&gt;</span>
</span><span class='line'>  <span class="n">@Html</span><span class="p">.</span><span class="n">ValidationDiv</span><span class="p">()</span>
</span><span class='line'>  <span class="n">@Html</span><span class="p">.</span><span class="n">FormBlock</span><span class="p">(</span><span class="n">aCommand</span> <span class="p">=&gt;</span> <span class="n">aCommand</span><span class="p">.</span><span class="n">LastName</span><span class="p">)</span>
</span><span class='line'>  <span class="n">@Html</span><span class="p">.</span><span class="n">FormBlock</span><span class="p">(</span><span class="n">aCommand</span> <span class="p">=&gt;</span> <span class="n">aCommand</span><span class="p">.</span><span class="n">FirstAndMiddleName</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;col-md-offset-2 col-md-10&quot;</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="p">&lt;</span><span class="n">input</span> <span class="n">type</span><span class="p">=</span><span class="s">&quot;submit&quot;</span> <span class="k">value</span><span class="p">=</span><span class="s">&quot;Create&quot;</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;btn btn-default&quot;</span> <span class="p">/&gt;</span>
</span><span class='line'>      <span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="err">@</span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">FeatureLink</span><span class="p">&lt;</span><span class="n">Index</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;(</span><span class="n">aLinkText</span><span class="p">:</span> <span class="s">&quot;Back to List&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="n">@section</span> <span class="n">Scripts</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">@Scripts</span><span class="p">.</span><span class="n">Render</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="s">&quot;~/bundles/jqueryval&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User\Index.cshtml</h2>

<p>In the Index.cshtml file update the create link to the following</p>

<p><code>@(Html.FeatureLink&lt;Create.UiController&gt;(aLinkText: &quot;Create New&quot;))</code></p>

<p>Compile, run and test.</p>

<h1>Feature User/Delete</h1>

<p>We are going to implement this asynchronously.
Create the <code>Delete</code> class in the <code>User</code> folder. </p>

<h2>User.Delete.Query</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">Query</span> <span class="p">:</span> <span class="n">IAsyncRequest</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">int</span> <span class="n">UserId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Delete.QueryHandler</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">QueryHandler</span> <span class="p">:</span> <span class="n">IAsyncRequestHandler</span><span class="p">&lt;</span><span class="n">Query</span><span class="p">,</span> <span class="n">Command</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">private</span> <span class="n">IDbContextScopeFactory</span> <span class="n">DbContextScopeFactory</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="nf">QueryHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">DbContextScopeFactory</span> <span class="p">=</span> <span class="n">aDbContextScopeFactory</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">&gt;</span> <span class="n">Handle</span><span class="p">(</span><span class="n">Query</span> <span class="n">aQuery</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">dbContextScope</span> <span class="p">=</span> <span class="n">DbContextScopeFactory</span><span class="p">.</span><span class="n">CreateReadOnly</span><span class="p">())</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">Model</span> <span class="n">model</span> <span class="p">=</span> <span class="n">dbContextScope</span><span class="p">.</span><span class="n">DbContexts</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">Model</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>                  <span class="k">return</span> <span class="k">await</span> <span class="n">model</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">aUser</span> <span class="p">=&gt;</span> <span class="n">aUser</span><span class="p">.</span><span class="n">UserId</span> <span class="p">==</span> <span class="n">aQuery</span><span class="p">.</span><span class="n">UserId</span><span class="p">).</span><span class="n">ProjectToSingleOrDefaultAsync</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">&gt;();</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Delete.Command</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">Command</span> <span class="p">:</span> <span class="n">IAsyncRequest</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">int</span> <span class="n">UserId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'><span class="na">         [Display(Name = &quot;First Name&quot;)]</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstAndMiddleName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>          <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Delete.CommandHandler</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">CommandHandler</span> <span class="p">:</span> <span class="n">AsyncRequestHandler</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">private</span> <span class="n">IDbContextScopeFactory</span> <span class="n">DbContextScopeFactory</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="nf">CommandHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">DbContextScopeFactory</span> <span class="p">=</span> <span class="n">aDbContextScopeFactory</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">protected</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">HandleCore</span><span class="p">(</span><span class="n">Command</span> <span class="n">aCommand</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">dbContextScope</span> <span class="p">=</span> <span class="n">DbContextScopeFactory</span><span class="p">.</span><span class="n">Create</span><span class="p">())</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">Model</span> <span class="n">model</span> <span class="p">=</span> <span class="n">dbContextScope</span><span class="p">.</span><span class="n">DbContexts</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">Model</span><span class="p">&gt;();</span>
</span><span class='line'>                  <span class="n">User</span> <span class="n">user</span> <span class="p">=</span> <span class="k">await</span> <span class="n">model</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="n">FindAsync</span><span class="p">(</span><span class="n">aCommand</span><span class="p">.</span><span class="n">UserId</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                  <span class="n">model</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</span><span class='line'>                  <span class="k">await</span> <span class="n">dbContextScope</span><span class="p">.</span><span class="n">SaveChangesAsync</span><span class="p">();</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Delete.UiController</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">UiController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMediator</span> <span class="n">mediator</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="nf">UiController</span><span class="p">(</span><span class="n">IMediator</span> <span class="n">aMediator</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">mediator</span> <span class="p">=</span> <span class="n">aMediator</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="k">virtual</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&gt;</span> <span class="n">Action</span><span class="p">(</span><span class="n">Query</span> <span class="n">aQuery</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">Command</span> <span class="n">command</span> <span class="p">=</span> <span class="k">await</span> <span class="n">mediator</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">aQuery</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">         [HttpPost]</span>
</span><span class='line'><span class="na">         [ValidateAntiForgeryToken]</span>
</span><span class='line'>          <span class="k">public</span> <span class="k">virtual</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&gt;</span> <span class="n">Action</span><span class="p">(</span><span class="n">Command</span> <span class="n">aCommand</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">await</span> <span class="n">mediator</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">aCommand</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">RedirectToFeatureJson</span><span class="p">&lt;</span><span class="n">Index</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Delete.MappingProfile</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">MappingProfile</span> <span class="p">:</span> <span class="n">Profile</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">()</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">CreateMap</span><span class="p">&lt;</span><span class="n">User</span><span class="p">,</span> <span class="n">Command</span><span class="p">&gt;().</span><span class="n">ReverseMap</span><span class="p">();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Delete.cshtml</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">@using</span> <span class="n">JimmyMvc</span><span class="p">.</span><span class="n">Features</span><span class="p">.</span><span class="n">User</span>
</span><span class='line'><span class="n">@model</span> <span class="n">Delete</span><span class="p">.</span><span class="n">Command</span>
</span><span class='line'>
</span><span class='line'><span class="err">@</span><span class="p">{</span>
</span><span class='line'>  <span class="n">ViewBag</span><span class="p">.</span><span class="n">Title</span> <span class="p">=</span> <span class="s">&quot;Delete&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">&lt;</span><span class="n">h2</span><span class="p">&gt;</span><span class="n">Delete</span><span class="p">&lt;/</span><span class="n">h2</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">&lt;</span><span class="n">p</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;error&quot;</span><span class="p">&gt;</span><span class="n">@ViewBag</span><span class="p">.</span><span class="n">ErrorMessage</span><span class="p">&lt;/</span><span class="n">p</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">&lt;</span><span class="n">h3</span><span class="p">&gt;</span><span class="n">Are</span> <span class="n">you</span> <span class="n">sure</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">delete</span> <span class="k">this</span><span class="p">?&lt;/</span><span class="n">h3</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">&lt;</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span><span class="n">h4</span><span class="p">&gt;</span><span class="n">User</span><span class="p">&lt;/</span><span class="n">h4</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span><span class="n">hr</span> <span class="p">/&gt;</span>
</span><span class='line'>  <span class="p">&lt;</span><span class="n">dl</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;dl-horizontal&quot;</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">dt</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="n">@Html</span><span class="p">.</span><span class="n">DisplayLabel</span><span class="p">(</span><span class="n">aModel</span> <span class="p">=&gt;</span> <span class="n">aModel</span><span class="p">.</span><span class="n">LastName</span><span class="p">)</span>
</span><span class='line'>      <span class="p">&lt;/</span><span class="n">dt</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">dd</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="n">@Html</span><span class="p">.</span><span class="n">Display</span><span class="p">(</span><span class="n">aModel</span> <span class="p">=&gt;</span> <span class="n">aModel</span><span class="p">.</span><span class="n">LastName</span><span class="p">)</span>
</span><span class='line'>      <span class="p">&lt;/</span><span class="n">dd</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">dt</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="n">@Html</span><span class="p">.</span><span class="n">Display</span><span class="p">(</span><span class="n">aModel</span> <span class="p">=&gt;</span> <span class="n">aModel</span><span class="p">.</span><span class="n">FirstAndMiddleName</span><span class="p">)</span>
</span><span class='line'>      <span class="p">&lt;/</span><span class="n">dt</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">dd</span><span class="p">&gt;</span>
</span><span class='line'>          <span class="n">@Html</span><span class="p">.</span><span class="n">DisplayFor</span><span class="p">(</span><span class="n">aModel</span> <span class="p">=&gt;</span> <span class="n">aModel</span><span class="p">.</span><span class="n">FirstAndMiddleName</span><span class="p">)</span>
</span><span class='line'>      <span class="p">&lt;/</span><span class="n">dd</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">&lt;/</span><span class="n">dl</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">@using</span> <span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">BeginForm</span><span class="p">())</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>  <span class="n">@Html</span><span class="p">.</span><span class="n">AntiForgeryToken</span><span class="p">()</span>
</span><span class='line'>  <span class="n">@Html</span><span class="p">.</span><span class="n">Input</span><span class="p">(</span><span class="n">aModel</span> <span class="p">=&gt;</span> <span class="n">aModel</span><span class="p">.</span><span class="n">UserId</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;form-actions no-color&quot;</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">&lt;</span><span class="n">input</span> <span class="n">type</span><span class="p">=</span><span class="s">&quot;submit&quot;</span> <span class="k">value</span><span class="p">=</span><span class="s">&quot;Delete&quot;</span> <span class="n">class</span><span class="p">=</span><span class="s">&quot;btn btn-default&quot;</span> <span class="p">/&gt;</span> <span class="p">|</span>
</span><span class='line'>      <span class="err">@</span><span class="p">(</span><span class="n">Html</span><span class="p">.</span><span class="n">FeatureLink</span><span class="p">&lt;</span><span class="n">Index</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;(</span><span class="n">aLinkText</span><span class="p">:</span> <span class="s">&quot;Back to List&quot;</span><span class="p">))</span>
</span><span class='line'>  <span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Index.cshtml</h2>

<p>Update the Delete link to the following:</p>

<p><code>@(Html.FeatureLink&lt;Delete.UiController&gt;(aLinkText: &quot;Delete&quot;, aRouteValues: new Delete.Query { UserId = item.UserId }))</code></p>

<p>Build, run test.</p>

<h1>Mediated Controllers</h1>

<p>Create a folder under Infrastructure named <code>MediatedControllers</code></p>

<h2>MediatedController</h2>

<p>Reviewing the UiControllers we notice many of them start with</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">UiController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMediator</span> <span class="n">mediator</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">public</span> <span class="nf">UiController</span><span class="p">(</span><span class="n">IMediator</span> <span class="n">aMediator</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">mediator</span> <span class="p">=</span> <span class="n">aMediator</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>So we can refactor.</p>

<p>Create a <code>MediatedControllers</code> Folder under the <code>Infrastructure</code> Folder and 
create a <code>MediatedController</code> class in <code>MediatedControllers</code> Folder as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.MediatedControllers</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">MediatedController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">protected</span> <span class="k">readonly</span> <span class="n">IMediator</span> <span class="n">Mediator</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="nf">MediatedController</span><span class="p">(</span><span class="n">IMediator</span> <span class="n">aMediator</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">Mediator</span> <span class="p">=</span> <span class="n">aMediator</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now we could change all the controllers that require a mediator to inherit from <code>MediatedController</code> instead of <code>Controller</code>. But hold off as we can refactor these even more DRYly.</p>

<h2>MediatedGetController</h2>

<p>Notice that all of the mediated controllers <code>get</code> operations send the Query to the mediator and then send the result to the View.
either Sync example</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>           <span class="k">public</span> <span class="k">virtual</span> <span class="n">ActionResult</span> <span class="nf">XXX</span><span class="p">(</span><span class="n">Query</span> <span class="n">aQuery</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">Command</span> <span class="n">command</span> <span class="p">=</span> <span class="n">mediator</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">aQuery</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>or Async example</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>           <span class="k">public</span> <span class="k">virtual</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&gt;</span> <span class="n">XXX</span><span class="p">(</span><span class="n">Query</span> <span class="n">aQuery</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">Result</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">mediator</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">aQuery</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>First we are going to create a generic controller that&#39;s action synchronously handles the http <code>Get</code> given a <code>Query</code> and returning a <code>Result</code> as follows:</p>

<p>Create <code>MediatedGetController</code> class in the <code>MediatedControllers</code> folder.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.MediatedControllers</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">MediatedGetController</span><span class="p">&lt;</span><span class="n">TQuery</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">MediatedController</span>
</span><span class='line'>  <span class="k">where</span> <span class="n">TQuery</span> <span class="p">:</span> <span class="n">IRequest</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="nf">MediatedGetController</span><span class="p">(</span><span class="n">IMediator</span> <span class="n">aMediator</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">aMediator</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">virtual</span> <span class="n">ActionResult</span> <span class="nf">Action</span><span class="p">(</span><span class="n">TQuery</span> <span class="n">aQuery</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">TResult</span> <span class="n">result</span> <span class="p">=</span> <span class="n">Mediator</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">aQuery</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">return</span> <span class="nf">HttpNotFound</span><span class="p">();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>MediatedAsyncGetController</h2>

<p>Now we will do the same for the async.</p>

<p>Create <code>MediatedAsyncGetController</code> class in the <code>MediatedControllers</code> folder.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.MediatedControllers</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">MediatedAsyncGetController</span><span class="p">&lt;</span><span class="n">TQuery</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">MediatedController</span>
</span><span class='line'>  <span class="k">where</span> <span class="n">TQuery</span> <span class="p">:</span> <span class="n">IAsyncRequest</span><span class="p">&lt;</span><span class="n">TResult</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="nf">MediatedAsyncGetController</span><span class="p">(</span><span class="n">IMediator</span> <span class="n">aMediator</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">aMediator</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">virtual</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&gt;</span> <span class="n">Action</span><span class="p">(</span><span class="n">TQuery</span> <span class="n">aQuery</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">TResult</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Mediator</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">aQuery</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">return</span> <span class="nf">HttpNotFound</span><span class="p">();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>MediatedGetPostController</h2>

<p>Looking at the controllers that handle the post we notice that they also handle the get as above. So we can inherit that portion. The post Action takes the command which is the result of the query and sends it out via the mediator and then returns a RedirectToActionJson which normally is to an index.
Again they can do it sync or async.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.MediatedControllers</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Extensions</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">MediatedGetPostController</span><span class="p">&lt;</span><span class="n">TQuery</span><span class="p">,</span> <span class="n">TCommand</span><span class="p">,</span> <span class="n">TRedirectController</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">MediatedGetController</span><span class="p">&lt;</span><span class="n">TQuery</span><span class="p">,</span> <span class="n">TCommand</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="k">where</span> <span class="n">TQuery</span> <span class="p">:</span> <span class="n">IRequest</span><span class="p">&lt;</span><span class="n">TCommand</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="k">where</span> <span class="n">TCommand</span> <span class="p">:</span> <span class="n">IRequest</span>
</span><span class='line'>      <span class="k">where</span> <span class="n">TRedirectController</span> <span class="p">:</span> <span class="n">Controller</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="nf">MediatedGetPostController</span><span class="p">(</span><span class="n">IMediator</span> <span class="n">aMediator</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">aMediator</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="na">     [HttpPost]</span>
</span><span class='line'><span class="na">     [ValidateAntiForgeryToken]</span>
</span><span class='line'>      <span class="k">public</span> <span class="k">virtual</span> <span class="n">ActionResult</span> <span class="nf">Action</span><span class="p">(</span><span class="n">TCommand</span> <span class="n">aCommand</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">Mediator</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">aCommand</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">RedirectToFeatureJson</span><span class="p">&lt;</span><span class="n">TRedirectController</span><span class="p">&gt;();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>MediatedAsyncGetPostController</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.MediatedControllers</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Extensions</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">MediatedAsyncGetPostController</span><span class="p">&lt;</span><span class="n">TQuery</span><span class="p">,</span> <span class="n">TCommand</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">MediatedAsyncGetController</span><span class="p">&lt;</span><span class="n">TQuery</span><span class="p">,</span> <span class="n">TCommand</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="k">where</span> <span class="n">TQuery</span> <span class="p">:</span> <span class="n">IAsyncRequest</span><span class="p">&lt;</span><span class="n">TCommand</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="k">where</span> <span class="n">TCommand</span> <span class="p">:</span> <span class="n">IAsyncRequest</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">public</span> <span class="nf">MediatedAsyncGetPostController</span><span class="p">(</span><span class="n">IMediator</span> <span class="n">aMediator</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">aMediator</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">ActionName</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="s">&quot;Index&quot;</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>  <span class="c1">// Default redirects to the Index</span>
</span><span class='line'>      <span class="k">public</span> <span class="k">virtual</span> <span class="kt">string</span> <span class="n">ControllerName</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span> <span class="c1">// Default is blank and thus the same controller that got here</span>
</span><span class='line'>
</span><span class='line'><span class="na">     [HttpPost]</span>
</span><span class='line'><span class="na">     [ValidateAntiForgeryToken]</span>
</span><span class='line'>      <span class="k">public</span> <span class="k">virtual</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&gt;</span> <span class="n">Action</span><span class="p">(</span><span class="n">TCommand</span> <span class="n">aCommand</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">await</span> <span class="n">Mediator</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">aCommand</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">RedirectToActionJson</span><span class="p">(</span><span class="n">ActionName</span><span class="p">,</span> <span class="n">ControllerName</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Refactor Controllers</h2>

<p>Now we can go back to each UiController and have them inherit from the appropriate type and thereby reduce the amount of code. Notice if we do not want this default handler we can simply inherit from Controller.</p>

<h3>User.Create.UiController</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">UiController</span> <span class="p">:</span> <span class="n">MediatedGetPostController</span><span class="p">&lt;</span><span class="n">Query</span><span class="p">,</span> <span class="n">Command</span><span class="p">,</span> <span class="n">Index</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="nf">UiController</span><span class="p">(</span><span class="n">IMediator</span> <span class="n">aMediator</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">aMediator</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure> 

<h3>User.Delete.UiController</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">UiController</span> <span class="p">:</span> <span class="n">MediatedAsyncGetPostController</span><span class="p">&lt;</span><span class="n">Query</span><span class="p">,</span> <span class="n">Command</span><span class="p">,</span> <span class="n">Index</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="nf">UiController</span><span class="p">(</span><span class="n">IMediator</span> <span class="n">aMediator</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">aMediator</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Details.UiController</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">UiController</span> <span class="p">:</span> <span class="n">MediatedAsyncGetController</span><span class="p">&lt;</span><span class="n">Query</span><span class="p">,</span> <span class="n">Result</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="nf">UiController</span><span class="p">(</span><span class="n">IMediator</span> <span class="n">aMediator</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">aMediator</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>User.Edit.UiController</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">UiController</span> <span class="p">:</span> <span class="n">MediatedAsyncGetPostController</span><span class="p">&lt;</span><span class="n">Query</span><span class="p">,</span> <span class="n">Command</span><span class="p">,</span> <span class="n">Index</span><span class="p">.</span><span class="n">UiController</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="nf">UiController</span><span class="p">(</span><span class="n">IMediator</span> <span class="n">aMediator</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">aMediator</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Build, run and test.</p>

<p>More refactoring</p>

<h1>RequestHandlers #</h1>

<p>Notice that the majority of the Handlers use a DbContext.  A single dbcontext per Handler method would normally suffice.  Although there are times that you may want to do parallel processing or even have a separate DbContext. So I want to make the normal single dbcontext easy without limiting options in case we want more control.</p>

<p>Also notice that for Queries we want a read only DbContext and for Commands we want a writeable context.
To do this we will create specialized default QueryHandlers and CommandHandlers and again support both sync and async.</p>

<h2>DbContextQueryHandler</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.RequestHandlers</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Mehdime.Entity</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Data.Entity</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">DbContextQueryHandler</span><span class="p">&lt;</span><span class="n">TQuery</span><span class="p">,</span> <span class="n">TResponse</span><span class="p">,</span> <span class="n">TDbContext</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">TQuery</span><span class="p">,</span> <span class="n">TResponse</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="k">where</span> <span class="n">TQuery</span> <span class="p">:</span> <span class="n">IRequest</span><span class="p">&lt;</span><span class="n">TResponse</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="k">where</span> <span class="n">TResponse</span> <span class="p">:</span> <span class="n">IRequest</span>
</span><span class='line'>      <span class="k">where</span> <span class="n">TDbContext</span> <span class="p">:</span> <span class="n">DbContext</span>
</span><span class='line'>  <span class="p">{</span>        
</span><span class='line'>      <span class="k">protected</span> <span class="n">IDbContextScopeFactory</span> <span class="n">DbContextScopeFactory</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="nf">DbContextQueryHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">DbContextScopeFactory</span> <span class="p">=</span> <span class="n">aDbContextScopeFactory</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="n">TResponse</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">TQuery</span> <span class="n">aQuery</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">dbContextScope</span> <span class="p">=</span> <span class="n">DbContextScopeFactory</span><span class="p">.</span><span class="n">CreateReadOnly</span><span class="p">())</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">TDbContext</span> <span class="n">dbContext</span> <span class="p">=</span> <span class="n">dbContextScope</span><span class="p">.</span><span class="n">DbContexts</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">TDbContext</span><span class="p">&gt;();</span>
</span><span class='line'>              <span class="k">return</span> <span class="nf">HandleInScope</span><span class="p">(</span><span class="n">aQuery</span><span class="p">,</span> <span class="n">dbContext</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">protected</span> <span class="k">virtual</span> <span class="n">TResponse</span> <span class="nf">HandleInScope</span><span class="p">(</span><span class="n">TQuery</span> <span class="n">aCommand</span><span class="p">,</span> <span class="n">TDbContext</span> <span class="n">aDbContext</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotImplementedException</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="s">&quot;Override this method in your Handler&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="nf">default</span><span class="p">(</span><span class="n">TResponse</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>AsyncDbContextQueryHandler</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.RequestHandlers</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Mehdime.Entity</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Data.Entity</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">class</span> <span class="nc">AsyncDbContextQueryHandler</span><span class="p">&lt;</span><span class="n">TQuery</span><span class="p">,</span> <span class="n">TResponse</span><span class="p">,</span> <span class="n">TDbContext</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IAsyncRequestHandler</span><span class="p">&lt;</span><span class="n">TQuery</span><span class="p">,</span> <span class="n">TResponse</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="k">where</span> <span class="n">TQuery</span> <span class="p">:</span> <span class="n">IAsyncRequest</span><span class="p">&lt;</span><span class="n">TResponse</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="k">where</span> <span class="n">TResponse</span><span class="p">:</span> <span class="n">IAsyncRequest</span>
</span><span class='line'>  <span class="k">where</span> <span class="n">TDbContext</span> <span class="p">:</span> <span class="n">DbContext</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">protected</span> <span class="n">IDbContextScopeFactory</span> <span class="n">DbContextScopeFactory</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="nf">AsyncDbContextQueryHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">DbContextScopeFactory</span> <span class="p">=</span> <span class="n">aDbContextScopeFactory</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TResponse</span><span class="p">&gt;</span> <span class="n">Handle</span><span class="p">(</span><span class="n">TQuery</span> <span class="n">aQuery</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">dbContextScope</span> <span class="p">=</span> <span class="n">DbContextScopeFactory</span><span class="p">.</span><span class="n">CreateReadOnly</span><span class="p">())</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">TDbContext</span> <span class="n">dbContext</span> <span class="p">=</span> <span class="n">dbContextScope</span><span class="p">.</span><span class="n">DbContexts</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">TDbContext</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">return</span> <span class="k">await</span> <span class="nf">HandleInScope</span><span class="p">(</span><span class="n">aQuery</span><span class="p">,</span> <span class="n">dbContext</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">protected</span> <span class="k">virtual</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">TResponse</span><span class="p">&gt;</span> <span class="n">HandleInScope</span><span class="p">(</span><span class="n">TQuery</span> <span class="n">aQuery</span><span class="p">,</span> <span class="n">TDbContext</span> <span class="n">aDbContext</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">FromException</span><span class="p">&lt;</span><span class="n">NotImplementedException</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">NotImplementedException</span><span class="p">());</span>
</span><span class='line'>          <span class="k">return</span> <span class="nf">default</span><span class="p">(</span><span class="n">TResponse</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>DbContextCommandHandler</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.RequestHandlers</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Mehdime.Entity</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Data.Entity</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">DbContextCommandHandler</span><span class="p">&lt;</span><span class="n">TCommand</span><span class="p">,</span> <span class="n">TDbContext</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">RequestHandler</span><span class="p">&lt;</span><span class="n">TCommand</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="k">where</span> <span class="n">TCommand</span> <span class="p">:</span> <span class="n">IRequest</span>
</span><span class='line'>      <span class="k">where</span> <span class="n">TDbContext</span> <span class="p">:</span> <span class="n">DbContext</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">protected</span> <span class="n">IDbContextScopeFactory</span> <span class="n">DbContextScopeFactory</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="nf">DbContextCommandHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">DbContextScopeFactory</span> <span class="p">=</span> <span class="n">aDbContextScopeFactory</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">HandleCore</span><span class="p">(</span><span class="n">TCommand</span> <span class="n">aCommand</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">dbContextScope</span> <span class="p">=</span> <span class="n">DbContextScopeFactory</span><span class="p">.</span><span class="n">Create</span><span class="p">())</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">TDbContext</span> <span class="n">dbContext</span> <span class="p">=</span> <span class="n">dbContextScope</span><span class="p">.</span><span class="n">DbContexts</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">TDbContext</span><span class="p">&gt;();</span>
</span><span class='line'>              
</span><span class='line'>              
</span><span class='line'>              <span class="n">HandleInScope</span><span class="p">(</span><span class="n">aCommand</span><span class="p">,</span> <span class="n">dbContext</span><span class="p">);</span>
</span><span class='line'>              <span class="n">dbContextScope</span><span class="p">.</span><span class="n">SaveChanges</span><span class="p">();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">HandleInScope</span><span class="p">(</span><span class="n">TCommand</span> <span class="n">aCommand</span><span class="p">,</span> <span class="n">TDbContext</span> <span class="n">aDbContext</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotImplementedException</span><span class="p">();</span>
</span><span class='line'>          <span class="k">return</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>AsyncDbContextCommandHandler</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">namespace</span> <span class="nn">JimmyMvc.Infrastructure.RequestHandlers</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">Mehdime.Entity</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Data.Entity</span><span class="p">;</span>
</span><span class='line'>  <span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">AsyncDbContextCommandHandler</span><span class="p">&lt;</span><span class="n">TCommand</span><span class="p">,</span><span class="n">TDbContext</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">AsyncRequestHandler</span><span class="p">&lt;</span><span class="n">TCommand</span><span class="p">&gt;</span>
</span><span class='line'>  <span class="k">where</span> <span class="n">TCommand</span> <span class="p">:</span> <span class="n">IAsyncRequest</span>
</span><span class='line'>  <span class="k">where</span> <span class="n">TDbContext</span> <span class="p">:</span> <span class="n">DbContext</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">protected</span> <span class="n">IDbContextScopeFactory</span> <span class="n">DbContextScopeFactory</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">public</span> <span class="nf">AsyncDbContextCommandHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">DbContextScopeFactory</span> <span class="p">=</span> <span class="n">aDbContextScopeFactory</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">protected</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">HandleCore</span><span class="p">(</span><span class="n">TCommand</span> <span class="n">message</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">dbContextScope</span> <span class="p">=</span> <span class="n">DbContextScopeFactory</span><span class="p">.</span><span class="n">Create</span><span class="p">())</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">TDbContext</span> <span class="n">dbContext</span> <span class="p">=</span> <span class="n">dbContextScope</span><span class="p">.</span><span class="n">DbContexts</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">TDbContext</span><span class="p">&gt;();</span>
</span><span class='line'>              
</span><span class='line'>              <span class="k">await</span> <span class="nf">HandleInScope</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">dbContext</span><span class="p">);</span>
</span><span class='line'>              <span class="k">await</span> <span class="n">dbContextScope</span><span class="p">.</span><span class="n">SaveChangesAsync</span><span class="p">();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">protected</span> <span class="k">virtual</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">HandleInScope</span><span class="p">(</span><span class="n">TCommand</span> <span class="n">aCommand</span><span class="p">,</span> <span class="n">TDbContext</span> <span class="n">aDbContext</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">FromException</span><span class="p">&lt;</span><span class="n">NotImplementedException</span><span class="p">&gt;(</span><span class="k">new</span> <span class="n">NotImplementedException</span><span class="p">());</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>These will clean up the handlers a little.  So lets go back and refactor them now.</p>

<h2>Create</h2>

<p>The QueryHandler for this doesn&#39;t need a dbcontext and is fine as is.</p>

<p>Update the CommandHandler as follows.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">CommandHandler</span> <span class="p">:</span> <span class="n">DbContextCommandHandler</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">,</span> <span class="n">Model</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="nf">CommandHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">aDbContextScopeFactory</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">HandleInScope</span><span class="p">(</span><span class="n">Command</span> <span class="n">aCommand</span><span class="p">,</span> <span class="n">Model</span> <span class="n">aModel</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">User</span> <span class="n">user</span> <span class="p">=</span> <span class="n">Mapper</span><span class="p">.</span><span class="n">Map</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">,</span> <span class="n">User</span><span class="p">&gt;(</span><span class="n">aCommand</span><span class="p">);</span>
</span><span class='line'>              <span class="n">aModel</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Delete</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>  <span class="n">TODO</span> <span class="n">Does</span> <span class="n">anything</span> <span class="n">go</span> <span class="n">here</span><span class="p">?</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Details</h2>

<p>Update the QueryHandler as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">QueryHandler</span> <span class="p">:</span> <span class="n">AsyncDbContextQueryHandler</span><span class="p">&lt;</span><span class="n">Query</span><span class="p">,</span> <span class="n">Command</span><span class="p">,</span> <span class="n">Model</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="nf">QueryHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">aDbContextScopeFactory</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">protected</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">&gt;</span> <span class="n">HandleInScope</span><span class="p">(</span><span class="n">Query</span> <span class="n">aQuery</span><span class="p">,</span> <span class="n">Model</span> <span class="n">aModel</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">return</span> <span class="k">await</span> <span class="n">aModel</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">aUser</span> <span class="p">=&gt;</span> <span class="n">aUser</span><span class="p">.</span><span class="n">UserId</span> <span class="p">==</span> <span class="n">aQuery</span><span class="p">.</span><span class="n">UserId</span><span class="p">).</span><span class="n">ProjectToSingleOrDefaultAsync</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">&gt;();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>And the CommandHandler as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">ComandHandler</span> <span class="p">:</span> <span class="n">AsyncDbContextCommandHandler</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">,</span> <span class="n">Model</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="nf">ComandHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">aDbContextScopeFactory</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">protected</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">HandleInScope</span><span class="p">(</span><span class="n">Command</span> <span class="n">aCommand</span><span class="p">,</span> <span class="n">Model</span> <span class="n">aModel</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">User</span> <span class="n">user</span> <span class="p">=</span> <span class="k">await</span> <span class="n">aModel</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="n">FindAsync</span><span class="p">(</span><span class="n">aCommand</span><span class="p">.</span><span class="n">UserId</span><span class="p">);</span>
</span><span class='line'>              <span class="n">aModel</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Details</h2>

<p>Update the QueryHandler</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">QueryHandler</span> <span class="p">:</span> <span class="n">AsyncDbContextQueryHandler</span><span class="p">&lt;</span><span class="n">Query</span><span class="p">,</span> <span class="n">Result</span><span class="p">,</span> <span class="n">Model</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="nf">QueryHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">aDbContextScopeFactory</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">protected</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Result</span><span class="p">&gt;</span> <span class="n">HandleInScope</span><span class="p">(</span><span class="n">Query</span> <span class="n">aQuery</span><span class="p">,</span> <span class="n">Model</span> <span class="n">aModel</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">Result</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">aModel</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">aUser</span> <span class="p">=&gt;</span> <span class="n">aUser</span><span class="p">.</span><span class="n">UserId</span> <span class="p">==</span> <span class="n">aQuery</span><span class="p">.</span><span class="n">UserId</span><span class="p">).</span><span class="n">ProjectToSingleOrDefaultAsync</span><span class="p">&lt;</span><span class="n">Result</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>              <span class="n">result</span><span class="p">.</span><span class="n">ApprovalListTemplates</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Result</span><span class="p">.</span><span class="n">ApprovalListTemplate</span><span class="p">&gt;();</span>
</span><span class='line'>              <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Edit</h2>

<p>Update QueryHandler:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">QueryHandler</span> <span class="p">:</span> <span class="n">AsyncDbContextQueryHandler</span><span class="p">&lt;</span><span class="n">Query</span><span class="p">,</span> <span class="n">Command</span><span class="p">,</span> <span class="n">Model</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="nf">QueryHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">aDbContextScopeFactory</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">protected</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">&gt;</span> <span class="n">HandleInScope</span><span class="p">(</span><span class="n">Query</span> <span class="n">aQuery</span><span class="p">,</span> <span class="n">Model</span> <span class="n">aModel</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="k">return</span> <span class="k">await</span> <span class="n">aModel</span><span class="p">.</span><span class="n">Users</span>
</span><span class='line'>                      <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">aUser</span> <span class="p">=&gt;</span> <span class="n">aUser</span><span class="p">.</span><span class="n">UserId</span> <span class="p">==</span> <span class="n">aQuery</span><span class="p">.</span><span class="n">UserId</span><span class="p">)</span>
</span><span class='line'>                      <span class="p">.</span><span class="n">ProjectToSingleOrDefaultAsync</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">&gt;();</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Update CommandHandler:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">CommandHandler</span> <span class="p">:</span> <span class="n">AsyncDbContextCommandHandler</span><span class="p">&lt;</span><span class="n">Command</span><span class="p">,</span> <span class="n">Model</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="nf">CommandHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">aDbContextScopeFactory</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">protected</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">HandleInScope</span><span class="p">(</span><span class="n">Command</span> <span class="n">aCommand</span><span class="p">,</span> <span class="n">Model</span> <span class="n">aModel</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="n">User</span> <span class="n">user</span> <span class="p">=</span> <span class="k">await</span> <span class="n">aModel</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="n">FindAsync</span><span class="p">(</span><span class="n">aCommand</span><span class="p">.</span><span class="n">UserId</span><span class="p">);</span>
</span><span class='line'>              <span class="n">Mapper</span><span class="p">.</span><span class="n">Map</span><span class="p">(</span><span class="n">aCommand</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<h2>Index</h2>

<p>Update QueryHandler</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>       <span class="k">public</span> <span class="k">class</span> <span class="nc">QueryHandler</span> <span class="p">:</span> <span class="n">DbContextQueryHandler</span><span class="p">&lt;</span><span class="n">Query</span><span class="p">,</span> <span class="n">Result</span><span class="p">,</span> <span class="n">Model</span><span class="p">&gt;</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">public</span> <span class="nf">QueryHandler</span><span class="p">(</span><span class="n">IDbContextScopeFactory</span> <span class="n">aDbContextScopeFactory</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">aDbContextScopeFactory</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">protected</span> <span class="k">override</span>  <span class="n">Result</span> <span class="nf">HandleInScope</span><span class="p">(</span><span class="n">Query</span> <span class="n">aQuery</span><span class="p">,</span> <span class="n">Model</span> <span class="n">aModel</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>              <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Result</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">CurrentSort</span> <span class="p">=</span> <span class="n">aQuery</span><span class="p">.</span><span class="n">SortOrder</span><span class="p">,</span>
</span><span class='line'>                  <span class="n">NameSortParm</span> <span class="p">=</span> <span class="n">String</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">aQuery</span><span class="p">.</span><span class="n">SortOrder</span><span class="p">)</span> <span class="p">?</span> <span class="s">&quot;name_desc&quot;</span> <span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">aQuery</span><span class="p">.</span><span class="n">SearchString</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">aQuery</span><span class="p">.</span><span class="n">Page</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="k">else</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">aQuery</span><span class="p">.</span><span class="n">SearchString</span> <span class="p">=</span> <span class="n">aQuery</span><span class="p">.</span><span class="n">CurrentFilter</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>              <span class="n">result</span><span class="p">.</span><span class="n">CurrentFilter</span> <span class="p">=</span> <span class="n">aQuery</span><span class="p">.</span><span class="n">SearchString</span><span class="p">;</span>
</span><span class='line'>              <span class="n">result</span><span class="p">.</span><span class="n">SearchString</span> <span class="p">=</span> <span class="n">aQuery</span><span class="p">.</span><span class="n">SearchString</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>              <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">users</span> <span class="p">=</span> <span class="k">from</span> <span class="n">s</span> <span class="k">in</span> <span class="n">aModel</span><span class="p">.</span><span class="n">Users</span> <span class="k">select</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(!</span><span class="n">String</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">aQuery</span><span class="p">.</span><span class="n">SearchString</span><span class="p">))</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="n">users</span> <span class="p">=</span> <span class="n">users</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">aUser</span> <span class="p">=&gt;</span> <span class="n">aUser</span><span class="p">.</span><span class="n">LastName</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">aQuery</span><span class="p">.</span><span class="n">SearchString</span><span class="p">)</span> <span class="p">||</span> <span class="n">aUser</span><span class="p">.</span><span class="n">FirstAndMiddleName</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">aQuery</span><span class="p">.</span><span class="n">SearchString</span><span class="p">));</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="k">switch</span> <span class="p">(</span><span class="n">aQuery</span><span class="p">.</span><span class="n">SortOrder</span><span class="p">)</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="k">case</span> <span class="s">&quot;name_desc&quot;</span><span class="p">:</span>
</span><span class='line'>                      <span class="n">users</span> <span class="p">=</span> <span class="n">users</span><span class="p">.</span><span class="n">OrderByDescending</span><span class="p">(</span><span class="n">aUser</span> <span class="p">=&gt;</span> <span class="n">aUser</span><span class="p">.</span><span class="n">LastName</span><span class="p">);</span>
</span><span class='line'>                      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                  <span class="k">default</span><span class="p">:</span> <span class="c1">// Name ascending </span>
</span><span class='line'>                      <span class="n">users</span> <span class="p">=</span> <span class="n">users</span><span class="p">.</span><span class="n">OrderBy</span><span class="p">(</span><span class="n">aUser</span> <span class="p">=&gt;</span> <span class="n">aUser</span><span class="p">.</span><span class="n">LastName</span><span class="p">);</span>
</span><span class='line'>                      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>              <span class="kt">int</span> <span class="n">pageSize</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
</span><span class='line'>              <span class="kt">int</span> <span class="n">pageNumber</span> <span class="p">=</span> <span class="p">(</span><span class="n">aQuery</span><span class="p">.</span><span class="n">Page</span> <span class="p">??</span> <span class="m">1</span><span class="p">);</span>
</span><span class='line'>              <span class="n">result</span><span class="p">.</span><span class="n">Users</span> <span class="p">=</span> <span class="n">users</span><span class="p">.</span><span class="n">ProjectToPagedList</span><span class="p">&lt;</span><span class="n">Result</span><span class="p">.</span><span class="n">User</span><span class="p">&gt;(</span><span class="n">pageNumber</span><span class="p">,</span> <span class="n">pageSize</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>              <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>So now I think you should understand the concept. You can now review the final code on github.</p>

<h1>Tools used in this blog</h1>

<p>Visual Studio 2015
2015-08-10</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Steven T. Cramer</span></span>

      




<time class='entry-date' datetime='2015-08-23T13:13:37-04:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>1:13 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/web/'>web</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://steventcramer.github.io//blog/2015/08/23/jimmy-mvc/" data-via="StevenTCramer" data-counturl="http://steventcramer.github.io//blog/2015/08/23/jimmy-mvc/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/08/23/hello-github-blog/" title="Previous Post: Hello Github Blog">&laquo; Hello Github Blog</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/08/26/plastic-scm-vs-git-rebase/" title="Next Post: Plastic SCM vs git Rebase">Plastic SCM vs git Rebase &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/08/26/plastic-scm-vs-git-rebase/">Plastic SCM vs Git Rebase</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/23/jimmy-mvc/">Building MVC Jimmy Style</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/23/hello-github-blog/">Hello Github Blog</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/StevenTCramer">@StevenTCramer</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'StevenTCramer',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/StevenTCramer?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Steven T. Cramer -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'crameroncode';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://steventcramer.github.io//blog/2015/08/23/jimmy-mvc/';
        var disqus_url = 'http://steventcramer.github.io//blog/2015/08/23/jimmy-mvc/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
